<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Perfil - Encanto Festas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3 { font-family: 'Baloo 2', cursive; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-500 font-medium">Carregando perfil...</p>
    </div>

    <!-- Auth Container (Login/Register) -->
    <div id="auth-container" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
        <div class="bg-blue-600 p-6 text-center">
            <h2 class="text-2xl text-white font-bold">Bem-vindo(a)!</h2>
            <p class="text-blue-100 text-sm">Fa√ßa login para gerenciar sua conta</p>
        </div>
        <div class="p-8">
            <button onclick="handleGoogleLogin()" class="w-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                Entrar com Google
            </button>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Ou use e-mail</span></div>
            </div>
            <!-- Login Form -->
            <form id="login-form" onsubmit="handleEmailLogin(event)" class="space-y-4">
                <input type="email" id="email" placeholder="Seu e-mail" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="password" placeholder="Sua senha" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">Entrar</button>
            </form>
            <p class="text-center mt-4 text-sm text-gray-600">
                Ainda n√£o tem conta? <button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Cadastre-se</button>
            </p>
        </div>
    </div>

    <!-- Profile Container (Logged In) -->
    <div id="profile-container" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden fade-in relative">
        <div class="h-32 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
        
        <div class="px-6 pb-6 text-center relative">
            <!-- Avatar Circle -->
            <div class="relative -mt-16 mb-4 inline-block">
                <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-blue-50 overflow-hidden mx-auto bg-white">
                    <img id="user-avatar" src="" class="w-full h-full object-cover" 
                         referrerpolicy="no-referrer"
                         onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback&backgroundColor=b6e3f4'">
                </div>
                <button onclick="toggleEditModal()" class="absolute bottom-2 right-0 bg-yellow-400 text-blue-900 p-2 rounded-full shadow-md hover:bg-yellow-300 transition" title="Mudar Avatar">
                    <i class="fas fa-pencil-alt text-sm"></i>
                </button>
            </div>

            <h2 id="user-name" class="text-2xl font-bold text-gray-800">Usu√°rio</h2>
            <p id="user-email" class="text-gray-500 text-sm mb-6">carregando...</p>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <span class="block text-2xl font-bold text-blue-600">0</span>
                    <span class="text-xs text-blue-400 uppercase font-bold">Festas</span>
                </div>
                <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100">
                    <span class="block text-2xl font-bold text-yellow-600">50</span>
                    <span class="text-xs text-yellow-500 uppercase font-bold">Pontos</span>
                </div>
            </div>

            <button onclick="logout()" class="w-full border border-red-200 text-red-500 hover:bg-red-50 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Sair da Conta
            </button>
        </div>
    </div>

    <!-- Edit Avatar Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-700">Editar Perfil</h3>
                <button onclick="toggleEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center">
                <img id="preview-avatar" src="" class="w-24 h-24 rounded-full mx-auto mb-4 bg-blue-50 border-4 border-white shadow-md object-cover"
                     referrerpolicy="no-referrer"
                     onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback&backgroundColor=b6e3f4'">
                
                <p class="text-sm font-bold text-gray-600 mb-3">Escolha seu estilo:</p>
                <div class="flex gap-3 justify-center mb-6">
                    <button onclick="setGender('male')" id="btn-male" class="flex-1 py-2 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition">üë¶ Menino</button>
                    <button onclick="setGender('female')" id="btn-female" class="flex-1 py-2 rounded-lg border-2 border-gray-200 hover:border-pink-500 hover:bg-pink-50 transition">üëß Menina</button>
                </div>

                <div class="text-left mb-4">
                    <label class="text-xs font-bold text-gray-500 ml-1">Seu Nome</label>
                    <input type="text" id="edit-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <button onclick="saveProfile()" id="btn-save" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg">
                    Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentGender = 'neutral';
        let tempAvatarUrl = '';

        // --- Inicializa√ß√£o ---
        async function init() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) { console.error(e); }
            }

            onAuthStateChanged(auth, async (user) => {
                const loading = document.getElementById('loading-screen');
                const authContainer = document.getElementById('auth-container');
                const profileContainer = document.getElementById('profile-container');

                if (user) {
                    authContainer.classList.add('hidden');
                    
                    const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'));
                    let data = userDoc.exists() ? userDoc.data() : {};
                    
                    // Avatar inicial seguro
                    const avatar = data.avatar || user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}&backgroundColor=b6e3f4`;
                    const name = data.name || user.displayName || "Usu√°rio";

                    document.getElementById('user-name').innerText = name;
                    document.getElementById('user-email').innerText = user.email;
                    document.getElementById('user-avatar').src = avatar;
                    
                    profileContainer.classList.remove('hidden');
                } else {
                    profileContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                }
                
                loading.classList.add('hidden');
            });
        }

        window.handleGoogleLogin = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) { alert("Erro no login Google: " + error.message); }
        };

        window.handleEmailLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (loginError) {
                    if (loginError.code === 'auth/invalid-credential' || loginError.code === 'auth/user-not-found') {
                        if(confirm("Conta n√£o encontrada. Deseja criar uma nova com estes dados?")) {
                            await createUserWithEmailAndPassword(auth, email, password);
                        }
                    } else { throw loginError; }
                }
            } catch (error) { alert("Erro: " + error.message); }
        };

        window.logout = () => signOut(auth);

        window.toggleEditModal = () => {
            const modal = document.getElementById('edit-modal');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                const currentSrc = document.getElementById('user-avatar').src;
                const currentName = document.getElementById('user-name').innerText;
                
                document.getElementById('edit-name').value = currentName;
                document.getElementById('preview-avatar').src = currentSrc;
                tempAvatarUrl = currentSrc;
                currentGender = null; 
                
                document.getElementById('btn-male').className = "flex-1 py-2 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition";
                document.getElementById('btn-female').className = "flex-1 py-2 rounded-lg border-2 border-gray-200 hover:border-pink-500 hover:bg-pink-50 transition";
                
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        };

        // --- Corre√ß√£o Cr√≠tica da URL do DiceBear ---
        window.setGender = (gender) => {
            currentGender = gender;
            const user = auth.currentUser;
            const seed = user.uid + Date.now(); 
            let url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=b6e3f4`;

            if (gender === 'male') {
                // Nomes EXATOS aceitos pela API v7 (nada de "shortHair" gen√©rico)
                const maleStyles = ["shortHairDreads01", "shortHairDreads02", "shortHairFrizzle", "shortHairShaggyMullet", "shortHairShortCurly", "shortHairShortFlat", "shortHairShortRound", "shortHairShortWaved", "shortHairSides", "shortHairTheCaesar", "shortHairTheCaesarSidePart"];
                
                // Constr√≥i query string repetindo o parametro top[]
                maleStyles.forEach(style => {
                    url += `&top[]=${style}`;
                });
                url += "&facialHairProbability=50";

                document.getElementById('btn-male').classList.add('border-blue-600', 'bg-blue-100');
                document.getElementById('btn-female').classList.remove('border-pink-600', 'bg-pink-100');
            } else {
                // Nomes EXATOS aceitos pela API v7
                const femaleStyles = ["longHairBigHair", "longHairBob", "longHairBun", "longHairCurly", "longHairCurvy", "longHairDreads", "longHairFrida", "longHairFro", "longHairFroBand", "longHairNotTooLong", "longHairShavedSides", "longHairMiaWallace", "longHairStraight", "longHairStraight2", "longHairStraightStrand"];
                
                femaleStyles.forEach(style => {
                    url += `&top[]=${style}`;
                });
                url += "&facialHairProbability=0";

                document.getElementById('btn-female').classList.add('border-pink-600', 'bg-pink-100');
                document.getElementById('btn-male').classList.remove('border-blue-600', 'bg-blue-100');
            }

            tempAvatarUrl = url;
            document.getElementById('preview-avatar').src = url;
        };

        window.saveProfile = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Salvando...";
            btn.disabled = true;

            try {
                const user = auth.currentUser;
                const newName = document.getElementById('edit-name').value;

                await updateProfile(user, { displayName: newName, photoURL: tempAvatarUrl });

                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                await setDoc(userRef, {
                    name: newName,
                    avatar: tempAvatarUrl,
                    email: user.email,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                document.getElementById('user-name').innerText = newName;
                document.getElementById('user-avatar').src = tempAvatarUrl;
                
                window.toggleEditModal();

            } catch (error) {
                console.error(error);
                alert("Erro ao salvar: " + error.message);
            } finally {
                btn.innerText = "Salvar Altera√ß√µes";
                btn.disabled = false;
            }
        };

        init();
    </script>
</body>
</html>
