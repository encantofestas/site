<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Perfil do Usuário</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    
    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Google Fonts (Inter) para um visual mais premium -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
        }
        .cropper-container {
            max-width: 100%;
        }
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out forwards;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 
      ========================================
      TELA 1: CARD DE PERFIL PRINCIPAL
      ========================================
    -->
    <main class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border border-white/50 relative">
        
        <!-- Cabeçalho Decorativo -->
        <div class="h-32 bg-gradient-to-r from-indigo-500 to-purple-600 w-full absolute top-0 left-0 z-0"></div>

        <div class="relative z-10 flex flex-col items-center pt-12 px-6 pb-8">
            
            <!-- Container do Avatar -->
            <div 
                class="relative group cursor-pointer"
                onclick="openModal()"
            >
                <div class="w-36 h-36 rounded-full p-1 bg-white shadow-lg">
                    <img 
                        id="avatarImage"
                        src="" 
                        alt="Avatar do Usuário" 
                        class="w-full h-full rounded-full object-cover bg-gray-100 transition-opacity duration-300 opacity-0"
                    >
                </div>

                <!-- Botão Flutuante de Lápis -->
                <button 
                    type="button" 
                    class="absolute bottom-2 right-2 p-2.5 bg-indigo-600 rounded-full shadow-lg border-2 border-white text-white hover:bg-indigo-700 active:scale-95 transition-all duration-200"
                    aria-label="Alterar Foto"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Informações do Usuário -->
            <div class="text-center mt-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight" id="userNameDisplay">Carregando...</h1>
                <p class="text-sm text-gray-500 font-medium" id="userEmailDisplay">carregando@exemplo.com</p>
            </div>

            <!-- Botão Editar Perfil (MOVIDO PARA CIMA) -->
            <button 
                onclick="openProfileEditModal()" 
                class="w-full py-2.5 bg-white border border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 hover:border-gray-300 hover:shadow-md active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2 mb-6"
            >
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Editar Perfil
            </button>
            
            <!-- Painel de Indicadores (Stats) -->
            <!-- Layout Flex com divisórias para alinhamento perfeito -->
            <div class="w-full flex items-center justify-between bg-gray-50 rounded-2xl p-4 border border-gray-100">
                
                <!-- Festas (Esquerda) -->
                <div class="flex-1 flex flex-col items-center justify-center">
                    <span class="text-xl font-bold text-indigo-600" id="partyCountDisplay">0</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Festas</span>
                </div>

                <!-- Divisória -->
                <div class="w-px h-8 bg-gray-200"></div>

                <!-- Pontos (Meio) -->
                <div class="flex-1 flex flex-col items-center justify-center">
                    <span class="text-xl font-bold text-emerald-500" id="userPointsDisplay">0</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Pontos</span>
                </div>
                
                <!-- Divisória -->
                <div class="w-px h-8 bg-gray-200"></div>

                <!-- Saldo (Direita) - Sem Cifrão -->
                <div class="flex-1 flex flex-col items-center justify-center">
                    <span class="text-xl font-bold text-amber-500" id="userBalanceDisplay">0,00</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Saldo</span>
                </div>
            </div>

        </div>
    </main>


    <!-- 
      ========================================
      TELA 2: MODAL DE SELEÇÃO DE AVATAR
      ========================================
    -->
    <div id="imageModal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-md modal-enter relative overflow-hidden">
            
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Alterar Foto</h2>
                <p class="text-sm text-gray-500">Escolha um avatar ou envie sua foto</p>
            </div>

            <div class="flex justify-center mb-8">
                <div 
                    class="relative w-48 h-48 rounded-full p-1 border-2 border-dashed border-indigo-200 hover:border-indigo-400 transition-colors group cursor-pointer"
                    onclick="document.getElementById('photoUploadInput').click();"
                    title="Clique para enviar uma foto"
                >
                    <img 
                        id="modalAvatarImage"
                        src="" 
                        alt="Visualização" 
                        class="w-full h-full rounded-full object-cover bg-gray-50"
                    >
                    
                    <div class="absolute inset-0 rounded-full flex flex-col items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <svg class="w-10 h-10 text-white mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.45 4h3.1a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-white text-xs font-semibold tracking-wide uppercase">Enviar Foto</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-8">
                <button 
                    onclick="generateMale()" 
                    class="gender-button py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-600 hover:bg-gray-200"
                    data-type="male"
                >
                    <span>Masculino</span>
                </button>
                <button 
                    onclick="generateFemale()" 
                    class="gender-button py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-600 hover:bg-gray-200"
                    data-type="female"
                >
                    <span>Feminino</span>
                </button>
            </div>

            <div class="pt-4 border-t border-gray-100 flex justify-end">
                <button 
                    onclick="closeModal()" 
                    class="px-6 py-2.5 bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-xl transition shadow-lg active:scale-95"
                >
                    Concluir
                </button>
            </div>
        </div>
    </div>


    <!-- 
      ========================================
      TELA 3: MODAL DE EDIÇÃO DE DADOS
      ========================================
    -->
    <div id="profileEditModal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-md modal-enter max-h-[90vh] overflow-y-auto">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Editar Perfil</h2>
                <button onclick="closeProfileEditModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-5">
                <!-- Nome -->
                <div class="space-y-1">
                    <label for="editName" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Nome Completo</label>
                    <input type="text" id="editName" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none" placeholder="Seu nome">
                </div>

                <!-- Email -->
                <div class="space-y-1">
                    <label for="editEmail" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Email</label>
                    <div class="relative">
                        <input type="email" id="editEmail" class="w-full px-4 py-3 rounded-xl bg-gray-100 border border-gray-200 text-gray-500 cursor-not-allowed" disabled>
                        <svg class="w-5 h-5 text-gray-400 absolute right-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </div>
                </div>

                <div class="py-2">
                    <div class="h-px bg-gray-100"></div>
                </div>

                <h3 class="text-sm font-bold text-indigo-600 uppercase tracking-wide">Endereço</h3>

                <!-- Bairro -->
                <div class="space-y-1">
                    <label for="editNeighborhood" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Bairro</label>
                    <div class="relative">
                        <select id="editNeighborhood" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none appearance-none">
                            <option value="">Selecione...</option>
                            <option value="Centro">Centro</option>
                            <option value="Jardim America">Jardim América</option>
                            <option value="Vila Nova">Vila Nova</option>
                            <option value="Outro">Outro</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <!-- Rua -->
                    <div class="col-span-2 space-y-1">
                        <label for="editStreet" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Rua</label>
                        <input type="text" id="editStreet" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none" placeholder="Nome da rua">
                    </div>

                    <!-- Número -->
                    <div class="space-y-1">
                        <label for="editHouseNumber" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Nº</label>
                        <input type="text" id="editHouseNumber" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none" placeholder="123">
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex gap-3 mt-8 pt-4 border-t border-gray-100">
                <button 
                    onclick="closeProfileEditModal()" 
                    class="flex-1 px-4 py-3 bg-white border border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition active:scale-[0.98]"
                >
                    Cancelar
                </button>
                <button 
                    onclick="saveProfileChanges()" 
                    class="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition active:scale-[0.98]"
                >
                    Salvar Alterações
                </button>
            </div>
        </div>
    </div>


    <!-- 
      ========================================
      TELA 4: MODAL DE RECORTE (CROPPER)
      ========================================
    -->
    <div id="cropperModal" class="fixed inset-0 z-[60] bg-black/90 hidden flex-col items-center justify-center p-0 md:p-4 backdrop-blur-md">
        <!-- Header Mobile -->
        <div class="w-full bg-black/50 p-4 absolute top-0 left-0 flex justify-between items-center md:hidden z-10">
            <h3 class="text-white font-medium">Ajustar Foto</h3>
            <button onclick="closeCropper()" class="text-white p-2">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="bg-gray-900 md:bg-white w-full h-full md:h-auto md:max-w-2xl md:rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            
            <div class="hidden md:flex justify-between items-center p-4 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800">Ajustar Foto</h3>
                <button onclick="closeCropper()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden">
                <img id="imageToCrop" src="" alt="Para cortar" class="block max-w-full">
            </div>
            
            <div class="p-4 bg-gray-900 md:bg-white border-t border-gray-800 md:border-gray-100 flex justify-end gap-3 z-20">
                <button 
                    onclick="closeCropper()" 
                    class="px-6 py-2.5 rounded-xl font-medium transition text-gray-300 hover:text-white md:text-gray-600 md:bg-gray-100 md:hover:bg-gray-200"
                >
                    Cancelar
                </button>
                <button 
                    onclick="cropImage()" 
                    class="px-8 py-2.5 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-500 md:hover:bg-indigo-700 shadow-lg transition active:scale-95 flex items-center gap-2"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <input type="file" id="photoUploadInput" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
    
    <script>
        // --- DADOS (MOCK) ---
        let userData = {
            name: 'Usuário Teste',
            email: 'usuario.teste@exemplo.com',
            address: {
                neighborhood: 'Vila Nova',
                street: 'Rua Principal da Cidade',
                number: '100A'
            },
            stats: {
                parties: 5,
                points: 1250,
                balance: 100.00
            }
        };

        // --- CONFIG ---
        const BASE_URL = "https://api.dicebear.com/9.x/avataaars/svg";
        const COMMON_PARAMS = "scale=110&radius=50&backgroundColor=b6e3f4,c0aede,d1d4f9";
        
        // Estado Interno
        let appState = {
            avatarType: 'male',
            cropper: null,
            loadTimeout: null
        };

        const HAIR_STYLES = {
            male: ["shortFlat", "shortRound", "shortWaved", "theCaesar", "theCaesarSidePart", "sides", "shortDreads1", "shortDreads2", "shortFrizzle", "shortCurly"],
            female: ["longButNotTooLong", "bob", "bun", "curly", "curvy", "straight1", "straight2", "straightStrand", "frida", "miaWallace", "bigHair", "shavedSides", "fro", "froBand"]
        };

        // --- UTILS ---
        const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getSeed = () => Math.random().toString(36).substring(2, 15);
        
        // Formata apenas o número, sem R$
        const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { 
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(val);

        // --- UI UPDATES ---
        function initUI() {
            // Preencher Tela 1
            document.getElementById('userNameDisplay').textContent = userData.name;
            document.getElementById('userEmailDisplay').textContent = userData.email;
            document.getElementById('partyCountDisplay').textContent = userData.stats.parties;
            document.getElementById('userPointsDisplay').textContent = userData.stats.points.toLocaleString('pt-BR');
            document.getElementById('userBalanceDisplay').textContent = formatBRL(userData.stats.balance);

            // Gerar avatar inicial
            generateMale();
        }

        function generateAvatar(type) {
            const seed = getSeed();
            const hair = getRandom(HAIR_STYLES[type]);
            // Ajuste probabilidade de barba baseado no gênero
            const beardProb = type === 'male' ? 30 : 0;
            
            const url = `${BASE_URL}?seed=${seed}&top=${hair}&facialHairProbability=${beardProb}&accessoriesProbability=0&${COMMON_PARAMS}`;
            
            appState.avatarType = type;
            updateAvatarImages(url);
            updateGenderButtons(type);
        }

        function generateMale() { generateAvatar('male'); }
        function generateFemale() { generateAvatar('female'); }

        function updateAvatarImages(url) {
            const imgs = [document.getElementById('avatarImage'), document.getElementById('modalAvatarImage')];
            
            if (appState.loadTimeout) clearTimeout(appState.loadTimeout);
            
            appState.loadTimeout = setTimeout(() => {
                console.warn("Retrying avatar load...");
                generateAvatar(appState.avatarType);
            }, 5000);

            imgs.forEach(img => {
                img.classList.remove('opacity-100');
                img.classList.add('opacity-0');
                img.src = url;
                
                img.onload = () => {
                    img.classList.remove('opacity-0');
                    img.classList.add('opacity-100');
                    if (appState.loadTimeout) clearTimeout(appState.loadTimeout);
                };

                img.onerror = () => {
                   // Tratamento silencioso
                };
            });
        }

        function updateGenderButtons(activeType) {
            document.querySelectorAll('.gender-button').forEach(btn => {
                const type = btn.getAttribute('data-type');
                btn.className = "gender-button py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 active:scale-95 flex items-center justify-center gap-2";
                
                if (type === activeType) {
                    if (type === 'male') btn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-200');
                    else btn.classList.add('bg-pink-500', 'text-white', 'shadow-lg', 'shadow-pink-200');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                }
            });
        }

        // --- MODALS ---
        const toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        };

        function openModal() {
            const mainSrc = document.getElementById('avatarImage').src;
            if (mainSrc) {
                const modalImg = document.getElementById('modalAvatarImage');
                modalImg.src = mainSrc;
                modalImg.classList.remove('opacity-0');
                modalImg.classList.add('opacity-100');
            }
            toggleModal('imageModal', true);
        }
        function closeModal() { toggleModal('imageModal', false); }

        function openProfileEditModal() {
            document.getElementById('editName').value = userData.name;
            document.getElementById('editEmail').value = userData.email;
            document.getElementById('editNeighborhood').value = userData.address.neighborhood;
            document.getElementById('editStreet').value = userData.address.street;
            document.getElementById('editHouseNumber').value = userData.address.number;
            toggleModal('profileEditModal', true);
        }
        function closeProfileEditModal() { toggleModal('profileEditModal', false); }

        function saveProfileChanges() {
            userData.name = document.getElementById('editName').value;
            userData.address.neighborhood = document.getElementById('editNeighborhood').value;
            userData.address.street = document.getElementById('editStreet').value;
            userData.address.number = document.getElementById('editHouseNumber').value;

            document.getElementById('userNameDisplay').textContent = userData.name;
            closeProfileEditModal();
        }

        // --- CROPPER / UPLOAD ---
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    closeModal(); 
                    openCropper(e.target.result);
                    input.value = ''; 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openCropper(src) {
            const img = document.getElementById('imageToCrop');
            img.src = src;
            toggleModal('cropperModal', true);

            if (appState.cropper) appState.cropper.destroy();

            setTimeout(() => {
                appState.cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false,
                    guides: true,
                });
            }, 100);
        }

        function cropImage() {
            if (!appState.cropper) return;
            
            const canvas = appState.cropper.getCroppedCanvas({
                width: 512, height: 512,
                imageSmoothingQuality: 'high'
            });

            updateAvatarImages(canvas.toDataURL('image/jpeg', 0.9));
            
            document.querySelectorAll('.gender-button').forEach(btn => {
                btn.className = "gender-button py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-600";
            });

            closeCropper();
        }

        function closeCropper() {
            toggleModal('cropperModal', false);
            if (appState.cropper) {
                appState.cropper.destroy();
                appState.cropper = null;
            }
        }

        // --- LISTENERS ---
        ['imageModal', 'profileEditModal'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if (e.target.id === id) toggleModal(id, false);
            });
        });

        document.addEventListener('DOMContentLoaded', initUI);

    </script>
</body>
</html>
