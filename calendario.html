<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Encanto Festas - Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { overflow-x: hidden; width: 100%; font-family: 'Inter', sans-serif; background-color: #ffffff; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        @media (min-width: 768px) { body { background-color: #f8fafc; } }
        h1, h2, h3, h4, .brand-font { font-family: 'Baloo 2', cursive; }
        .min-h-screen-safe { min-height: 100vh; min-height: 100dvh; }
        .bg-primary { background-color: #2563EB; }
        .text-primary { color: #2563EB; }
        .bg-secondary { background-color: #FACC15; }
        .floating-fab { box-shadow: 0 4px 15px rgba(250, 204, 21, 0.5); }
        .dia-celula { min-height: 50px; position: relative; cursor: pointer; transition: transform 0.1s, background-color 0.3s; padding: 2px; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0.1); }
        .dia-celula:active { transform: scale(0.95); }
        .dia-passado { opacity: 0.4; cursor: not-allowed; background-color: #f8fafc !important; color: #cbd5e1; pointer-events: none; }
        .dia-hoje { border: 2px solid #2563EB; font-weight: 700; z-index: 5; }
        .dia-numero { position: absolute; top: 2px; right: 4px; font-size: 0.85rem; font-weight: 600; color: rgba(0, 0, 0, 0.7); z-index: 10; }
        
        /* Cores de Status */
        .status-livre { background-color: #22c55e !important; color: white !important; } /* Verde */
        .status-pouco { background-color: #eab308 !important; color: white !important; } /* Amarelo */
        .status-esgotado { background-color: #ef4444 !important; color: white !important; } /* Vermelho */

        #toys-panel { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; z-index: 70; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; box-shadow: 0 -4px 25px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; display: flex; flex-direction: column; pointer-events: none; }
        #toys-panel.open { transform: translateY(0); pointer-events: auto; }
        #toys-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 60; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; pointer-events: none; }
        #toys-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
    </style>
</head>
<body class="text-gray-700 min-h-screen-safe flex flex-col">

    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 w-full bg-primary shadow-md z-50 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQdX7GkygoIKwK06MzeweiE0GPt5I1rsz808w&s" alt="Logo" class="w-10 h-10 rounded-full border-2 border-secondary object-cover shadow-inner" onerror="this.onerror=null;this.src='https://placehold.co/40x40/FACC15/2563EB?text=EF'">
                <span class="text-white text-2xl font-bold brand-font tracking-wide">Encanto<span class="text-yellow-300">Festas</span></span>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='carrinho.html'" class="bg-secondary text-blue-900 px-5 py-2 rounded-full font-bold hover:bg-yellow-300 shadow-lg hidden md:block">Agendar Agora</button>
            </div>
        </div>
    </header>

    <!-- OVERLAY E PAINEL DE BRINQUEDOS -->
    <div id="toys-overlay" onclick="closeToysPanel()"></div>
    <div id="toys-panel">
        <div class="w-full flex justify-center pt-3 pb-1" onclick="closeToysPanel()"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        
        <div id="panel-content-area" class="flex-grow overflow-y-auto" style="padding-bottom: 2rem;">
            <!-- View 1: Sele√ß√£o -->
            <div id="selection-view">
                <div class="px-5 pb-3 border-b border-gray-100 flex justify-between items-center">
                    <div><h3 class="text-lg font-bold text-gray-800 brand-font">Brinquedos Dispon√≠veis</h3><p id="selected-date-display" class="text-sm text-blue-600 font-medium">Data selecionada</p></div>
                    <button onclick="closeToysPanel()" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div id="panel-loading" class="p-8 text-center text-gray-500 hidden"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-2"></div><p>Carregando estoque...</p></div>
                <div id="panel-error" class="p-8 text-center text-red-500 hidden bg-red-50 m-4 rounded-lg border border-red-200">
                    <p class="font-bold text-lg">Erro ao carregar dados</p>
                    <p id="error-message-detail" class="text-sm mt-2 text-gray-700"></p>
                </div>
                
                <div class="p-4 space-y-4" id="toys-list-container"></div>
            </div>

            <!-- View 2: Checkout -->
            <div id="checkout-view" class="px-5 py-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800 brand-font">Finalizar Reserva</h3>
                    <button onclick="changeStep('selection')" class="text-blue-600 text-sm font-medium hover:text-blue-700">‚Üê Voltar</button>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner mb-6 border border-gray-100"><h4 class="font-bold text-gray-700 mb-2">Seu Pedido:</h4><div id="checkout-summary" class="text-sm text-gray-600 space-y-2"></div></div>
                <form id="checkout-form" onsubmit="event.preventDefault(); submitOrder()">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label><input type="text" id="client-name" required oninput="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Seu nome"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Bairro de Entrega</label>
                            <select id="client-neighborhood" required onchange="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="" disabled selected>Selecione</option><option value="Acara√≠">Acara√≠</option><option value="√Ågua Branca">√Ågua Branca</option><option value="Capri">Capri</option><option value="Centro - Sfs">Centro - Sfs</option><option value="Centro Hist√≥rico">Centro Hist√≥rico</option><option value="Enseada">Enseada</option><option value="Ervino">Ervino</option><option value="Iperoba">Iperoba</option><option value="Itagua√ßu">Itagua√ßu</option><option value="Laranjeiras">Laranjeiras</option><option value="Majorca">Majorca</option><option value="Miranda">Miranda</option><option value="Morro Grande">Morro Grande</option><option value="Paulas">Paulas</option><option value="Praia Grande">Praia Grande</option><option value="Reta">Reta</option><option value="Ribeira">Ribeira</option><option value="Rocio Grande">Rocio Grande</option><option value="Rocio Pequeno">Rocio Pequeno</option><option value="Sandra Regina">Sandra Regina</option><option value="Tapera">Tapera</option><option value="Ubatuba">Ubatuba</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <div class="flex-grow"><label class="block text-sm font-medium text-gray-700 mb-1">Nome da Rua</label><input type="text" id="client-street" required oninput="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Rua"></div>
                            <div class="w-24"><label class="block text-sm font-medium text-gray-700 mb-1">N¬∫</label><input type="number" id="client-number" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="N¬∫"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Ponto de Refer√™ncia</label><textarea id="client-reference" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Detalhes da casa..."></textarea></div>
                        <div class="flex flex-col">
                            <div class="flex space-x-2">
                                <div class="w-1/2"><label class="block text-sm font-medium text-gray-700 mb-1">In√≠cio</label><select id="event-start-time" required onchange="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="" disabled selected>--:--</option><option value="09">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select></div>
                                <div class="w-1/2"><label class="block text-sm font-medium text-gray-700 mb-1">T√©rmino</label><select id="event-end-time" required onchange="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="" disabled selected>--:--</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select></div>
                            </div>
                            <div id="time-fee-warning" class="text-xs text-red-600 mt-1 hidden font-normal"></div>
                        </div>
                        <div id="power-outlet-anchor"></div>
                        <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg"><select id="delivery-day-before" onchange="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="Nao">N√£o</option><option value="Sim">Sim</option></select><label class="text-sm font-medium text-gray-700">Pode levar um dia antes, pelo mesmo valor?</label></div>
                        <div id="rain-protection-field" class="space-y-3 p-3 bg-red-50 rounded-lg border border-red-200 hidden"><div class="flex items-center space-x-3"><input type="checkbox" id="rain-protection" class="w-5 h-5 text-red-600 border-gray-300 rounded"><label class="text-sm font-medium text-gray-700">A piscina fica totalmente coberta em caso de chuva</label></div></div>
                        <div class="space-y-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <label class="block text-sm font-bold text-gray-800 mb-1">Deseja contratar monitores?</label>
                            <select id="has-monitors" onchange="toggleMonitorFields(); calculateTotal();" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="Nao">N√£o</option><option value="Sim">Sim</option></select>
                            <div id="monitor-options" class="space-y-3 mt-3 hidden">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Quantos?</label><select id="monitor-count" onchange="renderMonitorHours(); calculateTotal();" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="1">1</option><option value="2">2</option></select></div>
                                <div id="monitor-hours-fields" class="space-y-3"></div>
                            </div>
                        </div>
                        <div class="space-y-2 p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center justify-between"><div class="flex items-center space-x-3"><input type="checkbox" id="additional-insurance" onchange="calculateTotal()" class="w-5 h-5 text-green-600 border-gray-300 rounded"><label for="additional-insurance" class="text-sm font-medium text-gray-700 select-none">Seguro Adicional</label></div><span class="text-sm font-bold text-green-700">+ R$ 10,00</span></div>
                            <p class="text-xs text-gray-500 mt-1">Ao adicionar o seguro, voc√™ n√£o paga por danos acidentais. Sem seguro, reparos podem custar at√© R$ 300,00.</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200"><label class="block text-sm font-medium text-gray-700 mb-1">Cupom de Desconto</label><div class="flex gap-2"><input type="text" id="discount-coupon" oninput="calculateTotal()" class="w-full px-3 py-2 border border-gray-300 rounded-lg uppercase" placeholder="C√≥digo"></div></div>
                        <div class="space-y-3 p-3 bg-gray-100 rounded-lg border border-gray-200"><div class="flex items-center space-x-3"><input type="checkbox" id="request-invoice" onchange="toggleCnpjField(); calculateTotal();" class="w-5 h-5 text-gray-600 border-gray-300 rounded"><label class="text-sm font-medium text-gray-700">Nota Fiscal (CNPJ)?</label></div><div id="cnpj-field" class="hidden"><input type="text" id="client-cnpj" name="client-cnpj" pattern="\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="00.000.000/0000-00"></div></div>
                    </div>
                </form>
            </div>
        </div>

        <!-- RODAP√â -->
        <div class="p-4 border-t border-gray-100 bg-white shadow-lg pb-8 md:pb-4 flex-shrink-0">
            <div id="total-summary-rows" class="space-y-1 text-sm text-gray-700 mb-2"></div>
            <div class="flex justify-between items-center mb-3 pt-2 border-t border-gray-300"><span class="text-lg font-bold text-gray-800">Total:</span><span id="total-price-display" class="text-xl md:text-2xl font-extrabold text-green-600">R$ 0,00</span></div>
            <button id="action-button" onclick="handleActionButton()" class="w-full bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 disabled:bg-gray-400" disabled>Continuar Agendamento</button>
        </div>
    </div>

    <!-- MAIN -->
    <main class="flex-grow w-full pt-24 pb-28 md:pb-12 bg-white md:bg-gray-50 flex flex-col items-center justify-start">
        <div class="w-full max-w-5xl bg-white p-4 md:p-8 md:mt-6 md:rounded-2xl md:shadow-xl border-b md:border-none border-gray-100">
            <h2 class="text-2xl md:text-3xl font-extrabold brand-font text-blue-600 mb-6 text-center leading-tight">Para a data <span id="display-date-main">...</span></h2>
            <div class="flex justify-between items-center mb-6 px-2">
                <button id="prev-month" class="nav-btn p-2 rounded-full text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-30"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg></button>
                <h3 id="current-month-year" class="text-xl md:text-2xl font-extrabold text-gray-800 tracking-wide text-center capitalize"></h3>
                <button id="next-month" class="nav-btn p-2 rounded-full text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-30"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div class="grid grid-cols-7 text-center font-bold text-xs sm:text-sm text-gray-500 border-b border-gray-100 pb-3 mb-2"><span class="p-1">DOM</span><span class="p-1">SEG</span><span class="p-1">TER</span><span class="p-1">QUA</span><span class="p-1">QUI</span><span class="p-1">SEX</span><span class="p-1">S√ÅB</span></div>
            <div id="calendar-body" class="grid grid-cols-7 gap-1 md:gap-2"></div>
            <div class="flex flex-wrap justify-center gap-x-3 gap-y-2 text-[10px] sm:text-xs font-semibold text-gray-600 mt-6 pt-4 border-t border-gray-100">
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full status-livre"></span><span>Muita disponibilidade</span></div>
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full status-pouco"></span><span>Pouca disponibilidade</span></div>
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full status-esgotado"></span><span>Indispon√≠vel</span></div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-8 hidden md:block"><div class="max-w-7xl mx-auto px-4 text-center text-gray-500"><p>&copy; 2024 EncantoFestas Loca√ß√µes. Feito com divers√£o.</p></div></footer>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 w-full bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] border-t border-gray-100 md:hidden z-50 flex items-start">
        <div class="grid grid-cols-5 w-full h-full relative">
            <a href="index.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" stroke-width="1.6"></path></svg><span class="text-[10px] font-medium mt-1">In√≠cio</span></a>
            <a href="combos.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="8" width="13" height="13" rx="2" stroke-width="2" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4H8a2 2 0 00-2 2v1" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 8V6a2 2 0 00-2-2h-3" /></svg><span class="text-[10px] font-medium mt-1">Combos</span></a>
            <div class="relative flex justify-center items-center h-full w-full"><a href="agendamento.html" class="floating-fab absolute -top-6 bg-secondary text-blue-900 w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-gray-50 z-10"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 9h.01M9 16h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11h4m-4 4h4" opacity="0.6"/></svg></a></div>
            <a href="catalogo.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg><span class="text-[10px] font-medium mt-1">Cat√°logo</span></a>
            <a href="perfil.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="text-[10px] font-medium mt-1">Perfil</span></a>
        </div>
    </nav>

    <script>
        let toysInventory = [], currentAvailableStock = {}, mockedDayData = {}, globalAgendamentos = {};
        let currentCalendarDate = new Date(); const today = new Date(); today.setHours(0, 0, 0, 0); const maxFutureDate = new Date(today.getFullYear(), today.getMonth() + 6, 1);
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const monthYearDisplay = document.getElementById('current-month-year'); const calendarBody = document.getElementById('calendar-body'); const prevButton = document.getElementById('prev-month'); const nextButton = document.getElementById('next-month');
        let currentSelectedDateISO = "";
        let selectedItems = {};
        let currentStep = 'selection';

        // L√ìGICA DE BUSCA LOCAL
        async function fetchData() {
            document.getElementById('panel-loading').classList.remove('hidden'); 
            document.getElementById('toys-list-container').classList.add('hidden');
            document.getElementById('panel-error').classList.add('hidden');
            
            try {
                // Tenta buscar o arquivo local
                const response = await fetch('estoque.json');
                
                if (!response.ok) {
                    throw new Error('Arquivo n√£o encontrado (404) ou erro de servidor.');
                }
                
                const data = await response.json();
                toysInventory = data.brinquedos || []; 
                processAvailability(data);
                document.getElementById('toys-list-container').classList.remove('hidden');
            } catch (error) { 
                console.error("Erro:", error); 
                document.getElementById('panel-error').classList.remove('hidden');
                
                // Mensagem de erro amig√°vel e explicativa
                const errorMsg = document.getElementById('error-message-detail');
                if (window.location.protocol === 'file:') {
                    errorMsg.innerHTML = `
                        <span class="block mb-2 font-bold text-red-600">‚ö†Ô∏è Bloqueio de Seguran√ßa do Navegador</span>
                        Voc√™ abriu o arquivo clicando nele diretamente? Navegadores n√£o permitem ler arquivos JSON assim.<br><br>
                        <b>Solu√ß√£o F√°cil:</b><br>
                        Use a extens√£o <b>"Live Server"</b> no VS Code.<br>
                        <i>(Clique com bot√£o direito no index.html > Open with Live Server)</i>
                    `;
                } else {
                    errorMsg.textContent = `N√£o foi poss√≠vel ler "estoque.json". Verifique se o nome est√° correto e na mesma pasta.`;
                }
            } 
            finally { 
                document.getElementById('panel-loading').classList.add('hidden'); 
                renderCalendar(); 
            }
        }

        function processAvailability(data) {
            globalAgendamentos = data.agendamentos || {};
            mockedDayData = {};

            if (data.agendamentos && toysInventory.length > 0) {
                for (const [rawDate, items] of Object.entries(data.agendamentos)) {
                    // Garante que a data do JSON (ex: "2025-12-10") seja lida corretamente
                    // Se o JSON tiver "2025-12-10", rawDate √© isso.
                    
                    let totalRentedCount = 0;
                    for (const quantity of Object.values(items)) { totalRentedCount += quantity; }

                    let cssClass = 'status-livre'; 
                    
                    const isLonaBooked = Object.keys(items).some(bookedId => {
                         const bookedToy = toysInventory.find(t => t.id == bookedId);
                         return bookedToy && bookedToy.exclusiveGroup === 'LONA' && items[bookedId] > 0;
                    });
                    
                    if (totalRentedCount >= 5) {
                        cssClass = 'status-esgotado'; 
                    } else if (totalRentedCount >= 3 || isLonaBooked) {
                        cssClass = 'status-pouco'; 
                    }
                    
                    mockedDayData[rawDate] = { cssClass: cssClass };
                }
            }
        }

        function getStockForDate(toyId, dateISO) {
            if (!toysInventory || toysInventory.length === 0) return 0;
            const toy = toysInventory.find(t => t.id === toyId); if (!toy) return 0;
            
            const rentedCount = globalAgendamentos[dateISO]?.[toyId] || 0;
                                
            if (toy.exclusiveGroup === 'LONA') {
                 const agendamentosDia = globalAgendamentos[dateISO] || {};
                 const isAnyLonaBooked = Object.keys(agendamentosDia).some(bookedId => {
                     const bookedToy = toysInventory.find(t => t.id == bookedId);
                     return bookedToy && bookedToy.exclusiveGroup === 'LONA' && agendamentosDia[bookedId] > 0;
                 });
                 if (isAnyLonaBooked) return 0;
            }
            return Math.max(0, toy.total_stock - rentedCount);
        }

        window.calculatePriceWithScarcity = function(toy) {
            if (toy.scarcityGroup === 'ELASTIC' || toy.scarcityGroup === 'BALL') {
                const maxStockIdeal = toy.scarcityGroup === 'ELASTIC' ? 3 : 2;
                const availableStock = getStockForDate(toy.id, currentSelectedDateISO);
                let basePrice = toy.price;
                if (availableStock < maxStockIdeal) {
                    const discount = (maxStockIdeal - availableStock) * 20;
                    return Math.max(basePrice - discount, basePrice - 60);
                }
            }
            return toy.price;
        }
        
        function calculateDurationFee() {
            const startStr = document.getElementById('event-start-time').value;
            const endStr = document.getElementById('event-end-time').value;
            if (!startStr || !endStr) return 0;
            const startHour = parseInt(startStr); const endHour = parseInt(endStr);
            let duration = endHour - startHour;
            if (duration <= 0) return 0; 
            let fee = 0; let warningText = "";
            const warningEl = document.getElementById('time-fee-warning');
            if (duration > 6) {
                fee = duration >= 8 ? 40 : 20;
                warningText = "Dura√ß√£o > 6h: taxa extra aplicada automaticamente.";
            }
            if (fee > 0) { warningEl.innerText = warningText; warningEl.classList.remove('hidden'); } else { warningEl.classList.add('hidden'); }
            return fee;
        }

        window.getSelectedItemDetails = function() {
            const details = []; let total = 0;
            toysInventory.forEach(toy => {
                const quantity = selectedItems[toy.id] || 0;
                if (quantity > 0) {
                    const pricePerUnit = window.calculatePriceWithScarcity(toy);
                    const lineTotal = quantity * pricePerUnit;
                    total += lineTotal; 
                    details.push({ name: toy.name, quantity: quantity, price: pricePerUnit, lineTotal: lineTotal, id: toy.id, needsPower: toy.needsPower });
                }
            }); return { details, total };
        }

        window.updateCheckoutSummary = function() {
            const { details, total: subtotal } = window.getSelectedItemDetails();
            const summaryDiv = document.getElementById('checkout-summary'); summaryDiv.innerHTML = '';
            const itemCount = details.reduce((acc, item) => acc + item.quantity, 0);
            const couponCode = document.getElementById('discount-coupon')?.value.trim().toLowerCase();
            const couponDiscount = (couponCode === 'encanto10') ? (subtotal * 0.10) : 0;
            const discountRate = itemCount >= 2 ? 0.05 : 0; const quantityDiscount = subtotal * discountRate;
            const neighborhood = document.getElementById('client-neighborhood')?.value;
            const extraShippingNeighborhoods = ['Capri', 'Enseada', 'Itagua√ßu', 'Laranjeiras', 'Majorca', 'Miranda', 'Praia Grande', 'Ribeira', 'Sandra Regina', 'Tapera', 'Ubatuba'];
            let shippingFee = 0;
            if (neighborhood === 'Ervino') shippingFee = 25.00;
            else if (extraShippingNeighborhoods.includes(neighborhood)) shippingFee = 10.00;
            const insuranceChecked = document.getElementById('additional-insurance')?.checked;
            const insuranceFee = insuranceChecked ? 10.00 : 0;
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            const monitorHours = parseFloat(document.getElementById('monitor-hours')?.value || 0);
            let monitorFee = 0; if (monitorCount > 0) { monitorFee = monitorCount * monitorHours * 30; }
            const timeFee = calculateDurationFee(); 
            details.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'border-b border-gray-200 py-1.5 last:border-b-0';
                itemContainer.innerHTML = `<div class="font-medium text-gray-700">${item.quantity}x ${item.name}</div><div class="text-sm font-bold text-green-600">R$ ${item.lineTotal.toFixed(2).replace('.', ',')}</div>`;
                summaryDiv.appendChild(itemContainer);
            });
            const summaryTotalDiv = document.getElementById('total-summary-rows'); summaryTotalDiv.innerHTML = '';
            summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Subtotal:</span><span>R$ ${subtotal.toFixed(2).replace('.', ',')}</span></div>`;
            if (monitorFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Monitores:</span><span>+ R$ ${monitorFee.toFixed(2).replace('.', ',')}</span></div>`;
            if (timeFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Taxa Dura√ß√£o:</span><span>+ R$ ${timeFee.toFixed(2).replace('.', ',')}</span></div>`; 
            if (quantityDiscount > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between text-green-600 font-bold"><span>Desconto Combo (5%):</span><span>- R$ ${quantityDiscount.toFixed(2).replace('.', ',')}</span></div>`; 
            if (couponDiscount > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between text-green-600 font-bold"><span>Cupom (10%):</span><span>- R$ ${couponDiscount.toFixed(2).replace('.', ',')}</span></div>`;
            if (shippingFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Taxa de Entrega:</span><span>R$ ${shippingFee.toFixed(2).replace('.', ',')}</span></div>`;
            if (insuranceFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Seguro Adicional:</span><span>R$ ${insuranceFee.toFixed(2).replace('.', ',')}</span></div>`;
        }
        
        window.calculateTotal = function() {
            const { details, total: subtotal } = window.getSelectedItemDetails();
            const itemCount = details.reduce((acc, item) => acc + item.quantity, 0);
            const discountRate = itemCount >= 2 ? 0.05 : 0; const quantityDiscount = subtotal * discountRate;
            const couponCode = document.getElementById('discount-coupon')?.value.trim().toLowerCase();
            const couponDiscount = (couponCode === 'encanto10') ? (subtotal * 0.10) : 0; 
            const neighborhood = document.getElementById('client-neighborhood')?.value;
            const insuranceChecked = document.getElementById('additional-insurance')?.checked;
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            const monitorHours = parseFloat(document.getElementById('monitor-hours')?.value || 0);
            let monitorFee = 0; if (monitorCount > 0) { monitorFee = monitorCount * monitorHours * 30; }
            const extraShippingNeighborhoods = ['Capri', 'Enseada', 'Itagua√ßu', 'Laranjeiras', 'Majorca', 'Miranda', 'Praia Grande', 'Ribeira', 'Sandra Regina', 'Tapera', 'Ubatuba'];
            let shippingFee = 0;
            if (neighborhood === 'Ervino') shippingFee = 25.00;
            else if (extraShippingNeighborhoods.includes(neighborhood)) shippingFee = 10.00;
            const insuranceFee = insuranceChecked ? 10.00 : 0;
            const timeFee = calculateDurationFee(); 
            const finalTotal = (subtotal - quantityDiscount - couponDiscount) + shippingFee + insuranceFee + monitorFee + timeFee;
            document.getElementById('total-price-display').innerText = `R$ ${finalTotal.toFixed(2).replace('.', ',')}`;
            const actionButton = document.getElementById('action-button');
            const totalItems = window.getSelectedItemDetails().details.length;
            const isValid = validateForm();
            actionButton.disabled = totalItems === 0;
            if (totalItems > 0 && currentStep === 'selection') { 
                actionButton.innerText = `Continuar Agendamento`; actionButton.classList.remove('bg-gray-400'); actionButton.classList.add('bg-primary');
            } else if (currentStep === 'checkout') { 
                actionButton.innerText = `Confirmar Reserva`; 
                if (isValid) { actionButton.classList.remove('bg-gray-400'); actionButton.classList.add('bg-primary'); } else { actionButton.classList.add('bg-gray-400'); actionButton.classList.remove('bg-primary'); }
            } else { actionButton.innerText = `Continuar Agendamento`; actionButton.classList.add('bg-gray-400'); }
            if (document.getElementById('total-summary-rows')) window.updateCheckoutSummary();
            const isBallPitSelected = details.some(item => item.id === 4 && item.quantity > 0);
            document.getElementById('rain-protection-field')?.classList.toggle('hidden', !isBallPitSelected);
        }
        
        window.validateForm = function() {
            if (currentStep !== 'checkout') return true; 
            const name = document.getElementById('client-name').value.trim();
            const neighborhood = document.getElementById('client-neighborhood').value;
            const street = document.getElementById('client-street').value.trim();
            const startTime = document.getElementById('event-start-time').value;
            const delivery = document.getElementById('delivery-day-before').value;
            return (name !== "" && neighborhood !== "" && street !== "" && startTime !== "" && delivery !== "");
        }
        
        window.updateQuantity = function(toyId, change) {
            const toy = toysInventory.find(t => t.id === toyId); if (!toy) return;
            const maxStock = getStockForDate(toyId, currentSelectedDateISO);
            let currentQty = selectedItems[toyId] || 0; let newQty = currentQty + change;
            if (newQty < 0) newQty = 0; if (newQty > maxStock) newQty = maxStock;
            if (toy.exclusiveGroup === 'LONA' && change > 0) {
                if (currentQty === 0) {
                    const otherLonaItem = toysInventory.find(t => t.exclusiveGroup === 'LONA' && t.id !== toyId && (selectedItems[t.id] || 0) > 0);
                    if (otherLonaItem) { alert(`Aten√ß√£o! Apenas um brinquedo de Lona Grande (${toy.name}) pode ser reservado por dia. Remova o(a) ${otherLonaItem.name} antes de adicionar.`); return; }
                }
                if (newQty > 1) newQty = 1;
            }
            selectedItems[toyId] = newQty;
            const qtyDisplay = document.getElementById(`qty-display-${toyId}`); if (qtyDisplay) qtyDisplay.innerText = newQty;
            window.calculateTotal();
            document.getElementById(`btn-minus-${toyId}`).disabled = newQty === 0;
            let disablePlus = newQty === maxStock;
            if (toy.exclusiveGroup === 'LONA' && newQty === 1) disablePlus = true;
            document.getElementById(`btn-plus-${toyId}`).disabled = disablePlus;
            if (toy.exclusiveGroup === 'LONA') {
                 const lonaToys = toysInventory.filter(t => t.exclusiveGroup === 'LONA');
                 const isLonaSelected = lonaToys.some(t => (selectedItems[t.id] || 0) > 0);
                 lonaToys.forEach(t => {
                     const btn = document.getElementById(`btn-plus-${t.id}`);
                     if (btn) {
                         if (isLonaSelected && (selectedItems[t.id] || 0) === 0) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); } 
                         else if (!isLonaSelected && (selectedItems[t.id] || 0) < getStockForDate(t.id, currentSelectedDateISO)) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
                     }
                 });
            }
        }

        window.renderPowerOutletFields = function() {
            const anchor = document.getElementById('power-outlet-anchor'); if (!anchor) return;
            anchor.innerHTML = '';
            const { details } = window.getSelectedItemDetails();
            const powerToys = details.filter(item => { const toyDef = toysInventory.find(t => t.id === item.id); return toyDef && toyDef.needsPower; });
            if (powerToys.length > 0) {
                const container = document.createElement('div'); container.id = 'power-outlet-fields-container'; container.className = 'space-y-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200 mt-4 mb-4';
                let htmlContent = `<label class="block text-sm font-bold text-indigo-800 mb-2">Selecione a dist√¢ncia da tomada</label>`;
                powerToys.forEach(toy => {
                    for(let i=1; i<=toy.quantity; i++) {
                         const label = toy.quantity > 1 ? `${toy.name} (#${i})` : toy.name; const inputId = `power-dist-${toy.id}-${i}`;
                         htmlContent += `<div><label for="${inputId}" class="block text-xs font-medium text-gray-700">${label}</label><input type="number" id="${inputId}" name="${inputId}" max="20" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Ex: 5m"></div>`;
                    }
                });
                container.innerHTML = htmlContent; anchor.appendChild(container);
            }
        }

        window.changeStep = function(step) {
            currentStep = step;
            const panelContent = document.getElementById('panel-content-area'); if (panelContent) panelContent.scrollTop = 0;
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('checkout-view').classList.add('hidden');
            if (step === 'checkout') { window.updateCheckoutSummary(); window.renderPowerOutletFields(); document.getElementById('checkout-view').classList.remove('hidden'); } else { document.getElementById('selection-view').classList.remove('hidden'); }
            window.calculateTotal();
        }

        window.handleActionButton = function() {
            if (currentStep === 'selection') {
                if (window.getSelectedItemDetails().details.length === 0) { alert('Selecione pelo menos um brinquedo.'); return; }
                window.changeStep('checkout');
            } else if (currentStep === 'checkout') { window.submitOrder(); }
        }

        window.submitOrder = function() {
            if (!validateForm()) {
                let missing = [];
                if (!document.getElementById('client-name').value.trim()) missing.push("Nome");
                if (!document.getElementById('client-neighborhood').value) missing.push("Bairro");
                if (!document.getElementById('client-street').value.trim()) missing.push("Nome da Rua");
                if (!document.getElementById('event-start-time').value) missing.push("Hor√°rio de In√≠cio");
                if (!document.getElementById('delivery-day-before').value) missing.push("Op√ß√£o de Entrega Antecipada");
                alert("Por favor, preencha os seguintes campos obrigat√≥rios antes de confirmar:\n- " + missing.join("\n- "));
                return;
            }
            const name = document.getElementById('client-name').value;
            const neighborhood = document.getElementById('client-neighborhood').value;
            const street = document.getElementById('client-street').value;
            const number = document.getElementById('client-number').value || 'S/N';
            const eventStartTime = document.getElementById('event-start-time').value;
            const eventEndTime = document.getElementById('event-end-time').value;
            if (!name || !neighborhood || !street || eventStartTime === "" || eventEndTime === "") { alert('Preencha os campos obrigat√≥rios.'); return; }
            const insuranceChecked = document.getElementById('additional-insurance').checked;
            const deliveryDayBeforeSelect = document.getElementById('delivery-day-before').value;
            const invoiceChecked = document.getElementById('request-invoice').checked;
            const cnpj = document.getElementById('client-cnpj').value;
            const rainProtection = document.getElementById('rain-protection')?.checked;
            const coupon = document.getElementById('discount-coupon').value;
            if (invoiceChecked && (!cnpj || !/^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/.test(cnpj))) { alert('CNPJ inv√°lido.'); return; }
            const powerInputs = document.querySelectorAll('#power-outlet-fields-container input[type="number"]'); let powerDetails = "";
            for (let input of powerInputs) {
                if (!input.value) { alert('Por favor, informe a dist√¢ncia da tomada para todos os brinquedos el√©tricos.'); return; }
                if (parseInt(input.value) > 20) { alert('A dist√¢ncia m√°xima da tomada √© 20 metros.'); return; }
                const label = input.previousElementSibling.innerText; powerDetails += `‚ö° ${label}: ${input.value}\n`;
            }
            const { details, total } = window.getSelectedItemDetails();
            let orderSummary = `*NOVO AGENDAMENTO*\nüìÖ Data: ${document.getElementById('selected-date-display').innerText.replace('Para ', '')}\nüë§ Nome: ${name}\nüìç Local: ${street}, ${number} - ${neighborhood}\nüìÑ CNPJ: ${invoiceChecked ? (cnpj || 'N√£o informado') : 'N√£o Solicitado'}\n‚è∞ Hor√°rio: ${eventStartTime} - ${eventEndTime}\nüöö Entr. Antecipada: ${deliveryDayBeforeSelect}\nüõ°Ô∏è Seguro: ${insuranceChecked ? 'SIM' : 'N√ÉO'}\n`;
            if (coupon) orderSummary += `üéüÔ∏è Cupom: ${coupon}\n`;
            const isBallPitIncluded = details.some(item => item.id === 4 && item.quantity > 0);
            if (isBallPitIncluded) orderSummary += `üåß Piscina Coberta: ${rainProtection ? 'SIM' : 'N√ÉO'}\n`;
            if (powerDetails) orderSummary += `\n*ENERGIA:*\n${powerDetails}`;
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            if (monitorCount > 0) { const monitorHours = document.getElementById('monitor-hours').value; orderSummary += `üëÆ Monitores: ${monitorCount} (${monitorHours}h)\n`; }
            const timeFee = calculateDurationFee(); if (timeFee > 0) orderSummary += `üïí Taxa Dura√ß√£o: R$ ${timeFee.toFixed(2)}\n`;
            orderSummary += `\n*ITENS:*\n`; details.forEach(item => { orderSummary += `‚Ä¢ ${item.quantity}x ${item.name}\n`; });
            const finalTotalText = document.getElementById('total-price-display').innerText; orderSummary += `\nüí∞ *TOTAL: ${finalTotalText}*`;
            window.open(`https://wa.me/5547992277324?text=${encodeURIComponent(orderSummary)}`, '_blank');
            window.closeToysPanel(); window.changeStep('selection'); 
        }
        
        window.closeToysPanel = function() { document.getElementById('toys-panel').classList.remove('open'); document.getElementById('toys-overlay').classList.remove('open'); document.body.style.overflow = ''; }
        window.renderMonitorHours = function() { const count = parseInt(document.getElementById('monitor-count').value); const hoursContainer = document.getElementById('monitor-hours-fields'); hoursContainer.innerHTML = ''; hoursContainer.innerHTML = `<div><label for="monitor-hours" class="block text-sm font-medium text-gray-700 mb-1">Horas Total</label><input type="number" id="monitor-hours" oninput="calculateTotal()" min="1" max="10" value="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Horas"></div>`; }
        window.toggleMonitorFields = function(isInitialLoad = false) { const shouldShow = document.getElementById('has-monitors').value === 'Sim'; document.getElementById('monitor-options').classList.toggle('hidden', !shouldShow); if (shouldShow && !isInitialLoad) { window.renderMonitorHours(); } else if (!shouldShow) { document.getElementById('monitor-hours-fields').innerHTML = ''; } }
        window.toggleCnpjField = function() { const shouldShow = document.getElementById('request-invoice').checked; document.getElementById('cnpj-field').classList.toggle('hidden', !shouldShow); document.getElementById('client-cnpj').required = shouldShow; }
        
        window.onload = function() { window.toggleMonitorFields(true); window.toggleCnpjField(); fetchData(); };
        function getDayStatus(year, month, day) { 
            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; 
            return mockedDayData[dateKey] || { cssClass: 'status-livre' }; 
        }
        function renderCalendar() {
            const currentMonth = currentCalendarDate.getMonth(); const currentYear = currentCalendarDate.getFullYear();
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`; calendarBody.innerHTML = '';
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfCurrentMonth = new Date(currentYear, currentMonth, 1); const firstDayOfNextMonth = new Date(currentYear, currentMonth + 1, 1);
            prevButton.disabled = firstDayOfCurrentMonth.getTime() === new Date(today.getFullYear(), today.getMonth(), 1).getTime();
            const isAtMaxFuture = firstDayOfNextMonth.getTime() >= maxFutureDate.getTime(); nextButton.disabled = isAtMaxFuture;
            nextButton.onclick = isAtMaxFuture ? showToast : navigateNext;
            for (let i = 0; i < firstDayOfMonth; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'dia-vazio p-2'; calendarBody.appendChild(emptyCell); }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day); const status = getDayStatus(currentYear, currentMonth, day);
                const cell = document.createElement('div'); 
                // CORRE√á√ÉO: Aplica√ß√£o correta da classe CSS
                cell.className = `dia-celula rounded-lg shadow-sm relative overflow-hidden ${status.cssClass}`;
                if (date.getTime() < today.getTime()) { cell.classList.add('dia-passado'); } else { cell.classList.add('text-gray-900'); cell.onclick = () => window.openToysPanel(day, currentMonth, currentYear); }
                if (date.getTime() === today.getTime()) cell.classList.add('dia-hoje');
                cell.innerHTML = `<div class="dia-numero">${day}</div>`; calendarBody.appendChild(cell);
            }
        }
        function navigatePrev() { if (prevButton.disabled) return; currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
        function navigateNext() { const nextMonthCheck = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1); if (nextMonthCheck.getTime() < maxFutureDate.getTime()) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }}
        prevButton.addEventListener('click', navigatePrev);

        // Notifica√ß√£o simplificada
        window.toggleNotificationPanel = function() { 
            // Implementa√ß√£o simples caso necess√°rio, mas removi o painel HTML para simplificar
            alert("Notifica√ß√µes em breve!");
        }
        function showToast() { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }

        document.addEventListener('DOMContentLoaded', () => { fetchData(); renderCalendar(); });
    </script>
</body>
</html>
