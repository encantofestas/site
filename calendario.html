<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Encanto Festas - Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { overflow-x: hidden; width: 100%; font-family: 'Inter', sans-serif; background-color: #ffffff; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        @media (min-width: 768px) { body { background-color: #f8fafc; } }
        h1, h2, h3, h4, .brand-font { font-family: 'Baloo 2', cursive; }
        .min-h-screen-safe { min-height: 100vh; min-height: 100dvh; }
        .bg-primary { background-color: #2563EB; }
        .text-primary { color: #2563EB; }
        .bg-secondary { background-color: #FACC15; }
        
        /* Ajustes da Bottom Bar */
        #bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(4rem + env(safe-area-inset-bottom));
        }
        .floating-fab { box-shadow: 0 4px 15px rgba(250, 204, 21, 0.5); }

        .dia-celula { min-height: 50px; position: relative; cursor: pointer; transition: transform 0.1s, background-color 0.3s; padding: 2px; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0.1); }
        .dia-celula:active { transform: scale(0.95); }
        .dia-passado { opacity: 0.4; cursor: not-allowed; background-color: #f8fafc !important; color: #cbd5e1; pointer-events: none; }
        .dia-hoje { border: 2px solid #2563EB; font-weight: 700; z-index: 5; }
        .dia-numero { position: absolute; top: 2px; right: 4px; font-size: 0.85rem; font-weight: 600; color: rgba(0, 0, 0, 0.7); z-index: 10; }
        
        /* Ajuste do toast para ficar ACIMA da barra de navegação (6rem) */
        #toast-notification { visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translate(-50%, 20px); left: 50%; position: fixed; bottom: 6rem; width: 90%; max-width: 400px; z-index: 80; pointer-events: none; }
        #toast-notification.show { visibility: visible; opacity: 1; transform: translate(-50%, 0); }
        
        /* Painel com Overscroll Contain para evitar rolar o fundo */
        #toys-panel { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; z-index: 70; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; box-shadow: 0 -4px 25px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; display: flex; flex-direction: column; pointer-events: none; overscroll-behavior: contain; }
        #toys-panel.open { transform: translateY(0); pointer-events: auto; }
        #toys-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 60; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; pointer-events: none; touch-action: none; }
        #toys-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
        
        #panel-content-area { overscroll-behavior: contain; }

        /* CSS Painel Notificações */
        #notification-panel { z-index: 100; transition: transform 0.3s ease-out; position: fixed; top: 0; right: 0; bottom: 0; width: 100vw; max-width: 100vw; height: 100dvh; background-color: #2563EB; pointer-events: none; transform: translateX(100%); }
        #notification-panel.open { pointer-events: auto; transform: translateX(0); }
        #notification-content { height: 100%; display: flex; flex-direction: column; }
        /* Animação Calendar Swipe */
        .calendar-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        
        /* ANIMAÇÃO DE DICA DE SCROLL DO FORMULÁRIO */
        @keyframes gentle-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        .scroll-hint-active {
            animation: gentle-float 2.5s ease-in-out infinite;
        }

        /* ESTILO DOS BOTÕES DE DIÁRIAS */
        .day-option {
            width: 45px;
            height: 45px;
            flex-shrink: 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-family: 'Baloo 2', cursive;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e2e8f0;
            background-color: white;
            color: #64748b;
            font-size: 1.1rem;
        }
        .day-option.selected {
            background-color: #2563EB;
            color: white;
            border-color: #2563EB;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Animação dos passos do formulário */
        .step-container {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .step-container.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-indicator {
            height: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .step-progress {
            height: 100%;
            background-color: #2563EB;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Modal Personalizado */
        #custom-modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 90;
            opacity: 0; visibility: hidden; transition: opacity 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
        }
        #custom-modal-overlay.open { opacity: 1; visibility: visible; }
        #custom-modal {
            background: white; border-radius: 1.5rem; width: 100%; max-width: 320px;
            transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 1.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #custom-modal-overlay.open #custom-modal { transform: scale(1); }
    </style>
</head>
<body class="text-gray-700 min-h-screen-safe flex flex-col">

    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 w-full bg-primary shadow-md z-50 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQdX7GkygoIKwK06MzeweiE0GPt5I1rsz808w&s" alt="Logo Encanto Festas" class="w-10 h-10 rounded-full border-2 border-secondary object-cover shadow-inner" onerror="this.onerror=null;this.src='https://placehold.co/40x40/FACC15/2563EB?text=EF'">
                <span class="text-white text-2xl font-bold brand-font tracking-wide">Encanto<span class="text-yellow-300">Festas</span></span>
            </div>
            <div class="hidden md:flex items-center space-x-4">
                <button id="desktop-notification-button" onclick="toggleNotificationPanel()" class="text-white p-2 relative rounded-full hover:bg-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 10a6 6 0 0 0-12 0c0 5-1.5 7-3 8h18c-1.5-1-3-3-3-8z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18v1a2 0 0 0 4 0v-1" /></svg><div class="notification-counter absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-primary leading-none hidden"></div></button>
                <button onclick="window.location.href='perfil.html'" class="text-white hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">Entrar</button>
                <button onclick="window.location.href='carrinho.html'" class="bg-secondary text-blue-900 px-5 py-2 rounded-full font-bold hover:bg-yellow-300 shadow-lg">Agendar Agora</button>
            </div>
            <button class="md:hidden text-white p-2 relative rounded-full hover:bg-blue-600" onclick="toggleNotificationPanel()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 10a6 6 0 0 0-12 0c0 5-1.5 7-3 8h18c-1.5-1-3-3-3-8z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18v1a2 0 0 0 4 0v-1" /></svg><div class="notification-counter absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-primary leading-none hidden"></div></button>
        </div>
    </header>

    <!-- TOAST -->
    <div id="toast-notification" class="bg-gray-800/95 backdrop-blur-sm text-white px-5 py-4 rounded-xl shadow-2xl z-[60] flex items-center justify-center space-x-3 text-center border border-gray-700">
        <svg class="w-6 h-6 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <span class="text-sm font-semibold leading-tight">Reservas permitidas apenas até 6 meses à frente.</span>
    </div>

    <!-- MODAL PERSONALIZADO -->
    <div id="custom-modal-overlay" onclick="closeCustomModal()">
        <div id="custom-modal" onclick="event.stopPropagation()">
            <div class="flex flex-col items-center">
                <div class="bg-red-100 p-3 rounded-full mb-3 text-red-500">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h4 class="text-lg font-bold text-gray-800 mb-2 brand-font">Item Indisponível</h4>
                <p id="custom-modal-message" class="text-sm text-gray-600 mb-5 leading-relaxed"></p>
                <button onclick="closeCustomModal()" class="bg-primary text-white w-full py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform">Entendi</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY E PAINEL DE BRINQUEDOS -->
    <div id="toys-overlay" onclick="closeToysPanel()"></div>
    <div id="toys-panel">
        <div class="w-full flex justify-center pt-3 pb-1" onclick="closeToysPanel()"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        
        <div id="panel-content-area" class="flex-grow overflow-y-auto" style="padding-bottom: 2rem;">
            <!-- View 1: Seleção -->
            <div id="selection-view">
                <div class="px-5 pb-3 border-b border-gray-100 flex justify-between items-center">
                    <div><h3 class="text-lg font-bold text-gray-800 brand-font">Brinquedos Disponíveis</h3><p id="selected-date-display" class="text-sm text-blue-600 font-medium">Data selecionada</p></div>
                    <button onclick="closeToysPanel()" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>

                <!-- FILTROS -->
                <div class="p-4 border-b border-gray-100 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Filtrar/Ordenar:</label>
                    <div class="flex space-x-3 overflow-x-auto pb-1">
                        <select id="sort-filter" onchange="renderToysList()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white flex-shrink-0">
                            <!-- PADRÃO: Mais Adquiridos -->
                            <option value="most_rented" selected>Mais Adquiridos</option>
                            <option value="name_asc">Nome (A-Z)</option>
                            <option value="name_desc">Nome (Z-A)</option>
                            <option value="age_asc">Faixa Etária (Cresc.)</option>
                        </select>
                        <!-- Filtro de Faixa Etária -->
                        <select id="age-filter" onchange="renderToysList()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white flex-shrink-0">
                            <option value="all">Todas as Idades</option>
                            <option value="L">Livre</option>
                            <option value="6">Max 6 Anos</option>
                            <option value="14">Max 14 Anos</option>
                        </select>
                    </div>
                </div>
                
                <div class="p-4 space-y-4" id="toys-list-container"></div>
            </div>

            <!-- View 2: Checkout (Agora com Wizard) -->
            <div id="checkout-view" class="px-5 py-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-gray-800 brand-font" id="checkout-title">Dados do Pedido</h3>
                    <button onclick="handleBackStep()" class="text-blue-600 text-sm font-medium hover:text-blue-700">← Voltar</button>
                </div>

                <div class="step-indicator">
                    <div id="progress-bar" class="step-progress" style="width: 20%;"></div>
                </div>
                <p id="step-label" class="text-xs text-gray-500 font-semibold mb-4 text-right">Passo 1 de 5</p>
                
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner mb-6 border border-gray-100 hidden" id="summary-container"><h4 class="font-bold text-gray-700 mb-2">Resumo do Pedido:</h4><div id="checkout-summary" class="text-sm text-gray-600 space-y-2"></div></div>
                
                <form id="checkout-form" onsubmit="event.preventDefault();">
                    
                    <!-- PASSO 1: Diárias e Nome -->
                    <div id="step-1" class="step-container active space-y-4">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <label class="block text-sm font-bold text-gray-800 mb-2">Quantas Diárias? <span class="text-xs font-normal text-blue-600 ml-1">(Promoção!)</span></label>
                            <div class="flex gap-3 overflow-x-auto pb-1" style="scrollbar-width: none; -ms-overflow-style: none;">
                                <div id="day-1" onclick="selectDays(1)" class="day-option selected cursor-pointer">1</div>
                                <div id="day-2" onclick="selectDays(2)" class="day-option cursor-pointer">2</div>
                                <div id="day-3" onclick="selectDays(3)" class="day-option cursor-pointer">3</div>
                                <div id="day-4" onclick="selectDays(4)" class="day-option cursor-pointer">4</div>
                                <div id="day-5" onclick="selectDays(5)" class="day-option cursor-pointer">5</div>
                            </div>
                            <p id="promo-message" class="text-xs text-blue-600 font-medium mt-2">Valor normal.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seu nome <span class="text-red-500">*</span></label>
                            <input type="text" id="client-name" oninput="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors" placeholder="">
                        </div>
                    </div>

                    <!-- PASSO 2: Endereço -->
                    <div id="step-2" class="step-container space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bairro de Entrega <span class="text-red-500">*</span></label>
                            <select id="client-neighborhood" onchange="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                <option value="" disabled selected>Selecione</option><option value="Acaraí">Acaraí</option><option value="Água Branca">Água Branca</option><option value="Capri">Capri</option><option value="Centro - Sfs">Centro - Sfs</option><option value="Centro Histórico">Centro Histórico</option><option value="Enseada">Enseada</option><option value="Ervino">Ervino</option><option value="Iperoba">Iperoba</option><option value="Itaguaçu">Itaguaçu</option><option value="Laranjeiras">Laranjeiras</option><option value="Majorca">Majorca</option><option value="Miranda">Miranda</option><option value="Morro Grande">Morro Grande</option><option value="Paulas">Paulas</option><option value="Praia Grande">Praia Grande</option><option value="Reta">Reta</option><option value="Ribeira">Ribeira</option><option value="Rocio Grande">Rocio Grande</option><option value="Rocio Pequeno">Rocio Pequeno</option><option value="Sandra Regina">Sandra Regina</option><option value="Tapera">Tapera</option><option value="Ubatuba">Ubatuba</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rua <span class="text-red-500">*</span></label>
                                <input type="text" id="client-street" oninput="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="Nome da Rua">
                            </div>
                            <div class="w-24">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nº</label>
                                <input type="number" id="client-number" oninput="if(this.value.length > 5) this.value = this.value.slice(0, 5);" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="Nº">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ponto de Referência</label>
                            <textarea id="client-reference" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="Detalhes da casa (cor, muro, etc)"></textarea>
                        </div>
                    </div>

                    <!-- PASSO 3: Logística e Monitores -->
                    <div id="step-3" class="step-container space-y-4">
                        <div class="flex flex-col">
                            <div class="flex space-x-2">
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Início da Festa <span class="text-red-500">*</span></label>
                                    <select id="event-start-time" onchange="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white"><option value="" disabled selected>--:--</option><option value="09">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select>
                                </div>
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Término <span class="text-red-500">*</span></label>
                                    <select id="event-end-time" onchange="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white"><option value="" disabled selected>--:--</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select>
                                </div>
                            </div>
                            <div id="time-fee-warning" class="text-xs text-gray-500 mt-1 hidden font-normal"></div>
                        </div>

                        <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                            <select id="delivery-day-before" onchange="calculateTotal()" class="w-20 px-2 py-2 border border-gray-300 rounded-lg bg-white text-sm font-bold">
                                <option value="Nao" selected>Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                            <label class="text-sm font-medium text-gray-700 leading-tight">Entregar/montar 1 dia antes pelo mesmo valor caso necessário?</label>
                        </div>

                        <div class="space-y-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <label class="block text-sm font-bold text-gray-800 mb-1">Deseja contratar monitores?</label>
                            <select id="has-monitors" onchange="toggleMonitorFields(); calculateTotal();" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="Nao" selected>Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                            <div id="monitor-options" class="space-y-3 mt-3 hidden">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Quantos?</label><select id="monitor-count" onchange="renderMonitorHours(); calculateTotal();" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="1">1</option><option value="2">2</option></select></div>
                                <div id="monitor-hours-fields" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- PASSO 4: Detalhes Técnicos (Piscina e Tomadas) -->
                    <div id="step-4" class="step-container space-y-4">
                        <div id="rain-protection-field" class="space-y-3 p-3 bg-red-50 rounded-lg border border-red-200 hidden">
                            <div class="space-y-1">
                                <label for="rain-protection" class="block text-sm font-medium text-gray-700 mb-1">A piscina fica totalmente coberta em caso de chuva (lona ou telhado)?</label>
                                <select id="rain-protection" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white">
                                    <option value="Nao" selected>Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="power-outlet-anchor"></div>
                    </div>

                    <!-- PASSO 5: Pagamento e Documentação -->
                    <div id="step-5" class="step-container space-y-4">
                        <div class="space-y-2 p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="additional-insurance" onchange="calculateTotal()" class="w-5 h-5 text-green-600 border-gray-300 rounded">
                                    <label for="additional-insurance" class="text-sm font-medium text-gray-700 select-none">Seguro Adicional <span class="font-bold text-green-600">(+ R$ 10,00)</span></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Cobre danos acidentais aos brinquedos. Sem seguro, o contratante arca com custos de reparo.</p>
                        </div>
                        
                        <div class="space-y-3 p-3 bg-gray-100 rounded-lg border border-gray-200">
                            <div class="space-y-1">
                                <label for="request-invoice" class="block text-sm font-medium text-gray-700 mb-1">Precisa de Nota Fiscal (PJ)?</label>
                                <select id="request-invoice" onchange="toggleCnpjField(); calculateTotal();" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white">
                                    <option value="Nao" selected>Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div id="cnpj-field" class="hidden mt-2">
                                <input type="text" id="client-cnpj" name="client-cnpj" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="CNPJ (00.000.000/0000-00)">
                            </div>
                        </div>

                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cupom de Desconto</label>
                            <input type="text" id="discount-coupon" oninput="calculateTotal()" class="w-full px-4 py-3 border border-gray-300 rounded-xl uppercase tracking-wider font-bold text-gray-600" placeholder="CÓDIGO">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- RODAPÉ -->
        <div class="p-4 border-t border-gray-100 bg-white shadow-lg pb-8 md:pb-4 flex-shrink-0">
            <div id="total-summary-rows" class="space-y-1 text-sm text-gray-700 mb-2"></div>
            <div class="flex justify-between items-center mb-3 pt-2 border-t border-gray-300"><span class="text-lg font-bold text-gray-800">Total:</span><span id="total-price-display" class="text-xl md:text-2xl font-extrabold text-green-600">R$ 0,00</span></div>
            <button id="action-button" onclick="handleActionButton()" class="w-full bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 disabled:bg-gray-400" disabled>Continuar Agendamento</button>
        </div>
    </div>

    <!-- NOTIFICAÇÕES (Lateral) -->
    <div id="notification-overlay" onclick="toggleNotificationPanel()" class="hidden fixed inset-0 bg-black bg-opacity-30 z-[80]"></div>
    <div id="notification-panel">
        <div id="notification-content">
            <div class="bg-blue-700 border-b border-blue-800 p-4 flex-none flex justify-between items-center z-10"><h3 class="text-xl font-bold brand-font text-white">Notificações</h3><button onclick="toggleNotificationPanel()" class="text-blue-200 hover:text-white p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
            <div class="flex-grow overflow-y-auto relative"><ul id="notification-list" class="p-4 space-y-3 pb-24"></ul><div id="loading-notifications" class="p-4 text-center hidden"><div class="animate-spin inline-block w-6 h-6 border-4 border-blue-300 border-t-transparent rounded-full"></div><p class="text-sm text-blue-200 mt-2">Carregando...</p></div></div>
            <div class="p-2 border-t border-blue-800 bg-blue-700 text-center flex-none w-full" style="padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));"><button id="mark-all-button" onclick="markAllAsRead()" class="text-white font-semibold text-xs uppercase tracking-wide hover:text-blue-200 hover:underline disabled:opacity-50">Marcar todas como lidas</button></div>
        </div>
    </div>

    <!-- MAIN -->
    <main class="flex-grow w-full pt-24 pb-28 md:pb-12 bg-white md:bg-gray-50 flex flex-col items-center justify-start">
        <!-- WRAPPER DO CALENDÁRIO COM ID PARA EVENTOS -->
        <div id="calendar-wrapper" class="w-full max-w-5xl bg-white p-4 md:p-8 md:mt-6 md:rounded-2xl md:shadow-xl border-b md:border-none border-gray-100 calendar-transition relative overflow-hidden">
            <h2 class="text-2xl md:text-3xl font-extrabold brand-font text-blue-600 mb-6 text-center leading-tight">Para a data <span id="display-date-main">...</span></h2>
            <div class="flex justify-between items-center mb-6 px-2">
                <button id="prev-month" class="nav-btn p-2 rounded-full text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-30"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg></button>
                <h3 id="current-month-year" class="text-xl md:text-2xl font-extrabold text-gray-800 tracking-wide text-center capitalize"></h3>
                <button id="next-month" class="nav-btn p-2 rounded-full text-blue-600 hover:bg-blue-50 active:bg-blue-100" onclick="navigateNext()"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div class="grid grid-cols-7 text-center font-bold text-xs sm:text-sm text-gray-500 border-b border-gray-100 pb-3 mb-2"><span class="p-1">DOM</span><span class="p-1">SEG</span><span class="p-1">TER</span><span class="p-1">QUA</span><span class="p-1">QUI</span><span class="p-1">SEX</span><span class="p-1">SÁB</span></div>
            <div id="calendar-body" class="grid grid-cols-7 gap-1 md:gap-2"></div>
            
            <!-- LEGENDA NOVA COM 4 CORES -->
            <div class="flex flex-wrap justify-center gap-x-3 gap-y-2 text-[10px] sm:text-xs font-semibold text-gray-600 mt-6 pt-4 border-t border-gray-100">
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span><span>Tudo disponível</span></div>
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full bg-amber-400"></span><span>Alguns reservados</span></div>
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full bg-orange-500"></span><span>Poucos disponíveis</span></div>
                <div class="flex items-center space-x-1.5 bg-gray-50 px-2 py-1 rounded-md"><span class="w-2.5 h-2.5 rounded-full bg-red-500"></span><span>Indisponível</span></div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-8 hidden md:block"><div class="max-w-7xl mx-auto px-4 text-center text-gray-500"><p>&copy; 2024 EncantoFestas Locações. Feito com diversão.</p></div></footer>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 w-full bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)] border-t border-gray-100 z-50 flex items-start">
        <div class="grid grid-cols-5 w-full h-full relative">
            
            <!-- Item 1: Início (Agora Apenas Borda/Outline) -->
            <a href="index.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition group cursor-pointer">
                <svg class="w-6 h-6 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-[10px] font-medium">Início</span>
            </a>
            
            <!-- Item 2: Combos -->
            <a href="combos.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition group cursor-pointer">
                <svg class="w-6 h-6 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="8" width="13" height="13" rx="2" stroke-width="2" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4H8a2 2 0 00-2 2v1" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 8V6a2 2 0 00-2-2h-3" />
                </svg>
                <span class="text-[10px] font-medium">Combos</span>
            </a>
            
            <!-- Item 3: FAB Central (Calendário) -->
            <div class="relative flex justify-center items-center h-full w-full">
                <a href="calendario.html" class="cursor-pointer floating-fab absolute -top-6 bg-secondary text-blue-900 w-14 h-14 rounded-full flex items-center justify-center shadow-lg transform active:scale-95 transition hover:scale-105 border-4 border-gray-50 z-10">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 9h.01M9 16h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11h4m-4 4h4" opacity="0.6"/>
                    </svg>
                </a>
            </div>
            
            <!-- Item 4: Catálogo -->
            <a href="catalogo.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition group cursor-pointer">
                <svg class="w-6 h-6 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                </svg>
                <span class="text-[10px] font-medium">Catálogo</span>
            </a>
            
            <!-- Item 5: Perfil -->
            <a href="perfil.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition group cursor-pointer">
                <svg class="w-6 h-6 mb-1 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-[10px] font-medium">Perfil</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('silent');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth, userId, isAuthReady = false, unsubscribeNotifications = null, isPanelOpen = false, currentStep = 'selection', checkoutSubStep = 1, selectedItems = {};
        
        let selectedDayCount = 1; 

        // DADOS ESTÁTICOS
        const staticData = {
          "brinquedos": [
            { "id": 1, "name": "Cama Elástica Pequena", "total_stock": 1, "price": 170, "measure": "2,44m", "needsPower": false, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/camap.webp" },
            { "id": 2, "name": "Cama Elástica Média", "total_stock": 3, "price": 190, "measure": "3,05m", "scarcityGroup": "ELASTIC", "needsPower": false, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/camam.webp" },
            { "id": 3, "name": "Castelinho Pula Pula", "total_stock": 1, "price": 210, "measure": "3m", "needsPower": true, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/castelinho.webp" },
            { "id": 4, "name": "Piscina de Bolinhas", "total_stock": 2, "price": 160, "measure": "1,5 (descoberto) / 2m (coberto)", "scarcityGroup": "BALL", "needsPower": false, "ageRating": "L", "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/piscina.webp" },
            { "id": 5, "name": "Área Baby", "total_stock": 1, "price": 110, "measure": "", "needsPower": false, "ageRating": 6, "image": "https://raw.githubusercontent.com/encantofestas/site/f0ea7af4a6e04cd75b86a553e57b76b013d87efc/areababy.webp" },
            { "id": 6, "name": "Mini Baby Inflável", "total_stock": 1, "price": 220, "measure": "", "needsPower": true, "ageRating": 6, "image": "https://raw.githubusercontent.com/encantofestas/site/a720b1e6ac30fc028c9396ed923e43d0436a8b5c/minibaby.webp" },
            { "id": 7, "name": "Escorrega com Bolinha", "total_stock": 1, "price": 400, "measure": "", "exclusiveGroup": "LONA", "needsPower": true, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/escorregobol.webp" },
            { "id": 8, "name": "Tobogã Médio", "total_stock": 1, "price": 400, "measure": "5 x 3m", "exclusiveGroup": "LONA", "needsPower": true, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/tobogam.webp" },
            { "id": 9, "name": "Futebol de Sabão", "total_stock": 1, "price": 600, "measure": "8 x 4m", "exclusiveGroup": "LONA", "needsPower": true, "ageRating": 14, "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/futebol.webp" },
            { "id": 10, "name": "Pebolim", "total_stock": 1, "price": 200, "measure": "", "needsPower": false, "ageRating": "L", "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/pebolim.webp" },
            { "id": 11, "name": "Air Hockey", "total_stock": 1, "price": 200, "measure": "", "needsPower": true, "ageRating": "L", "image": "https://raw.githubusercontent.com/encantofestas/site/f0ea7af4a6e04cd75b86a553e57b76b013d87efc/aero.webp" },
            { "id": 12, "name": "Ping Pong", "total_stock": 1, "price": 200, "measure": "", "needsPower": false, "ageRating": "L", "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/pingpong.webp" },
            { "id": 13, "name": "Jogos de Mesa", "total_stock": 4, "price": 15, "measure": "Padrão", "note": "Kit", "needsPower": false, "ageRating": "L", "image": "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/mesas.webp" }
          ],
          "agendamentos": {
            "2025-12-10": { "2": 1, "4": 1 },
            "2025-12-13": { "1": 1, "2": 1, "8": 1, "9": 1 },
            "2025-12-14": { "2": 2, "4": 2 },
            "2025-12-17": { "10": 1, "12": 1, "2": 2, "4": 1, "11": 1, "8": 1, "5": 1, "3": 1, "6": 1 },
            "2025-12-20": { "1": 1, "2": 3, "3": 1, "4": 2, "5": 1, "6": 1, "7": 1, "10": 1, "11": 1, "12": 1, "13": 4 },
            "2025-12-21": { "7": 1 },
            "2025-12-24": { "3": 1, "13": 4, "2": 1, "4": 1 },
            "2026-01-10": { "3": 1, "2": 1, "4": 1 },
            "2026-01-16": { "1": 1 },
            "2026-04-18": { "10": 1, "11": 1, "12": 1 }
          }
        };

        let toysInventory = [], currentAvailableStock = {}, mockedDayData = {}, globalAgendamentos = {};
        let currentCalendarDate = new Date(); const today = new Date(); today.setHours(0, 0, 0, 0); const maxFutureDate = new Date(today.getFullYear(), today.getMonth() + 6, 1);
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const monthYearDisplay = document.getElementById('current-month-year'); const calendarBody = document.getElementById('calendar-body'); const prevButton = document.getElementById('prev-month'); const nextButton = document.getElementById('next-month'); const toast = document.getElementById('toast-notification');
        let currentSelectedDateISO = "";

        // SWIPE LOGIC
        let touchStartX = 0;
        let touchEndX = 0;
        const calendarWrapper = document.getElementById('calendar-wrapper');

        calendarWrapper.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        calendarWrapper.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                if (!nextButton.disabled) navigateNext();
            }
            if (touchEndX > touchStartX + 50) {
                if (!prevButton.disabled) navigatePrev();
            }
        }
        
        // HELPERS
        function getAgeRatingBadge(ageRating) {
            if (ageRating === 'L') return { text: 'L', color: 'bg-green-500', title: 'Livre' };
            if (ageRating === 6) return { text: '6', color: 'bg-blue-500', title: 'Até 6 anos' };
            if (ageRating === 14) return { text: '14', color: 'bg-orange-500', title: 'Até 14 anos' };
            return { text: '?', color: 'bg-gray-400', title: 'Idade não informada' };
        }
        
        function addDays(dateStr, days) {
            const result = new Date(dateStr + 'T00:00:00');
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        }

        // --- NOVO: FUNÇÕES DO MODAL PERSONALIZADO ---
        window.showErrorModal = function(message) {
            document.getElementById('custom-modal-message').innerText = message;
            document.getElementById('custom-modal-overlay').classList.add('open');
        }
        window.closeCustomModal = function() {
            document.getElementById('custom-modal-overlay').classList.remove('open');
        }

        function checkRangeAvailability() {
            if (selectedDayCount === 1) return { valid: true };

            const startDate = currentSelectedDateISO;
            const itemsToCheck = [];
            
            for (const [toyId, qty] of Object.entries(selectedItems)) {
                if (qty > 0) itemsToCheck.push({ id: parseInt(toyId), qty });
            }
            
            if (itemsToCheck.length === 0) return { valid: true };

            for (let i = 0; i < selectedDayCount; i++) {
                const checkDate = addDays(startDate, i);
                
                for (const item of itemsToCheck) {
                    const toy = toysInventory.find(t => t.id === item.id);
                    const stockOnDate = getStockForDate(item.id, checkDate);
                    
                    if (stockOnDate < item.qty) {
                        const dateObj = new Date(checkDate + 'T00:00:00');
                        const dateFormatted = dateObj.toLocaleDateString('pt-BR');
                        // Mensagem amigável para o modal
                        return { 
                            valid: false, 
                            message: `O item "${toy.name}" já está reservado para o dia ${dateFormatted}. Por favor, ajuste as datas ou a quantidade.` 
                        };
                    }
                }
            }
            return { valid: true };
        }

        function loadStaticData() {
            toysInventory = staticData.brinquedos; 
            processAvailability(staticData);
            renderCalendar();
        }

        function processAvailability(data) {
            globalAgendamentos = data.agendamentos || {};
            
            for (const [date, items] of Object.entries(data.agendamentos)) {
                let realRemainingStock = 0;
                
                const lonaToys = toysInventory.filter(t => t.exclusiveGroup === 'LONA');
                let isLonaBooked = false;
                if (lonaToys.length > 0) {
                     isLonaBooked = Object.keys(items).some(id => {
                         const toy = toysInventory.find(t => t.id == id);
                         return toy && toy.exclusiveGroup === 'LONA';
                     });
                }

                toysInventory.forEach(toy => {
                     let stock = toy.total_stock;
                     const rented = items[toy.id] || 0;
                     if (toy.exclusiveGroup === 'LONA' && isLonaBooked) {
                         if (rented === 0) stock = 0; 
                         else stock = stock - rented;
                     } else {
                         stock = stock - rented;
                     }
                     realRemainingStock += Math.max(0, stock);
                });

                let color = 'bg-green-500';
                
                // NOVA LÓGICA DE CORES
                if (realRemainingStock === 0) {
                    color = 'bg-red-500'; // Indisponível (0 sobrando)
                } 
                else if (realRemainingStock < 10) {
                    color = 'bg-orange-500'; // Poucos disponíveis (< 10 sobrando)
                } 
                else if (realRemainingStock >= 10) {
                    // Verifica se houve alguma reserva
                    const totalRentedToday = Object.values(items).reduce((a, b) => a + b, 0);
                    
                    if (totalRentedToday === 0) {
                         color = 'bg-green-500'; // Nenhuma reserva feita
                    } else {
                         color = 'bg-amber-400'; // Tem reserva, mas sobra muito (10+)
                    }
                }

                mockedDayData[date] = { color: color };
            }
        }

        function getStockForDate(toyId, dateISO) {
            if (!toysInventory || toysInventory.length === 0) return 0;
            const toy = toysInventory.find(t => t.id === toyId); if (!toy) return 0;
            const rentedCount = globalAgendamentos[dateISO]?.[toyId] || 0;
            
            if (toy.exclusiveGroup === 'LONA') {
                 const agendamentosDia = globalAgendamentos[dateISO] || {};
                 const isAnyLonaBooked = Object.keys(agendamentosDia).some(bookedId => {
                     const bookedToy = toysInventory.find(t => t.id == bookedId);
                     return bookedToy && bookedToy.exclusiveGroup === 'LONA' && agendamentosDia[bookedId] > 0;
                 });
                 if (isAnyLonaBooked && (rentedCount === 0)) return 0;
            }
            return Math.max(0, toy.total_stock - rentedCount);
        }

        window.calculatePriceWithScarcity = function(toy) {
            if (toy.scarcityGroup === 'ELASTIC' || toy.scarcityGroup === 'BALL') {
                const maxStockIdeal = toy.scarcityGroup === 'ELASTIC' ? 3 : 2;
                const availableStock = getStockForDate(toy.id, currentSelectedDateISO);
                let basePrice = toy.price;
                if (availableStock < maxStockIdeal) {
                    const discount = (maxStockIdeal - availableStock) * 20;
                    return Math.max(basePrice - discount, basePrice - 60);
                }
            }
            return toy.price;
        }
        
        function calculateDurationFee() {
            const startStr = document.getElementById('event-start-time').value;
            const endStr = document.getElementById('event-end-time').value;
            const warningEl = document.getElementById('time-fee-warning');
            
            if (!startStr || !endStr) {
                if(warningEl) warningEl.classList.add('hidden');
                return 0;
            }
            
            const startHour = parseInt(startStr);
            const endHour = parseInt(endStr);
            let duration = endHour - startHour;
            
            if (duration <= 0) {
                 if(warningEl) warningEl.classList.add('hidden');
                 return 0; 
            }
            
            if (duration > 6) {
                if(warningEl) {
                    warningEl.innerText = "Períodos acima de 6 horas possuem uma pequena taxa adicional.";
                    warningEl.classList.remove('hidden');
                }
                return duration >= 8 ? 40 : 20;
            } else {
                if(warningEl) warningEl.classList.add('hidden');
            }
            return 0;
        }

        window.getSelectedItemDetails = function() {
            const details = []; let total = 0;
            toysInventory.forEach(toy => {
                const quantity = selectedItems[toy.id] || 0;
                if (quantity > 0) {
                    const pricePerUnit = window.calculatePriceWithScarcity(toy);
                    const lineTotal = quantity * pricePerUnit;
                    total += lineTotal; 
                    details.push({ 
                        name: toy.name, 
                        quantity: quantity, 
                        price: pricePerUnit, 
                        lineTotal: lineTotal, 
                        id: toy.id, 
                        needsPower: toy.needsPower 
                    });
                }
            }); return { details, total };
        }

        window.selectDays = function(days) {
            const previousDays = selectedDayCount;
            selectedDayCount = days; 
            
            const availability = checkRangeAvailability();
            if (!availability.valid) {
                // USANDO O NOVO MODAL
                window.showErrorModal(availability.message);
                selectedDayCount = previousDays; 
                return; 
            }

            for(let i=1; i<=5; i++) {
                const el = document.getElementById(`day-${i}`);
                if(i === days) el.classList.add('selected');
                else el.classList.remove('selected');
            }
            
            const promoEl = document.getElementById('promo-message');
            if (days === 1) promoEl.innerText = "Valor normal.";
            else if (days === 2) promoEl.innerText = "Promoção: 30% OFF no 2º dia!";
            else if (days === 3) promoEl.innerText = "Super Promo: 3 diárias com desconto!";
            else promoEl.innerText = "Pacote estendido com desconto aplicado!";
            
            calculateTotal();
        }

        window.updateCheckoutSummary = function() {
            const { details, total: subtotal } = window.getSelectedItemDetails();
            const summaryDiv = document.getElementById('checkout-summary'); summaryDiv.innerHTML = '';
            
            const itemCount = details.reduce((acc, item) => acc + item.quantity, 0);
            
            // LÓGICA DE CUPOM DE DESCONTO ATUALIZADA (20%)
            const valid20PercentCoupons = ["fsd8s2", "jof383", "939fjs"];
            const valid10PercentCoupon = "encanto10";
            const couponCode = document.getElementById('discount-coupon')?.value.trim().toLowerCase();
            
            let couponRate = 0;
            if (valid20PercentCoupons.includes(couponCode)) {
                couponRate = 0.20;
            } else if (couponCode === valid10PercentCoupon) {
                couponRate = 0.10;
            }
            
            const discountRate = itemCount >= 2 ? 0.05 : 0; 
            const quantityDiscount = subtotal * discountRate; 

            const neighborhood = document.getElementById('client-neighborhood')?.value;
            const extraShippingNeighborhoods = ['Capri', 'Enseada', 'Itaguaçu', 'Laranjeiras', 'Majorca', 'Miranda', 'Praia Grande', 'Ribeira', 'Sandra Regina', 'Tapera', 'Ubatuba'];
            let shippingFee = 0;
            if (neighborhood === 'Ervino') shippingFee = 25.00;
            else if (extraShippingNeighborhoods.includes(neighborhood)) shippingFee = 10.00;

            const insuranceChecked = document.getElementById('additional-insurance')?.checked;
            const insuranceFee = insuranceChecked ? 10.00 : 0;
            
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            const monitorHours = parseFloat(document.getElementById('monitor-hours')?.value || 0);
            let monitorFee = 0;
            
            let daysMultiplier = 1;
            if (selectedDayCount === 2) daysMultiplier = 1.7;
            else if (selectedDayCount === 3) daysMultiplier = 2.3;
            else if (selectedDayCount === 4) daysMultiplier = 2.8;
            else if (selectedDayCount === 5) daysMultiplier = 3.2;
            
            if (monitorCount > 0) {
                monitorFee = (monitorCount * monitorHours * 30) * selectedDayCount;
            }
            
            const timeFee = calculateDurationFee(); 

            details.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'border-b border-gray-200 py-1.5 last:border-b-0';
                const pricePerUnit = window.calculatePriceWithScarcity(toysInventory.find(t => t.id === item.id)); 
                const lineTotal = (item.quantity * pricePerUnit) * daysMultiplier;
                
                itemContainer.innerHTML = `<div class="font-medium text-gray-700">${item.quantity}x ${item.name} <span class="text-xs text-blue-500">(${selectedDayCount} dias)</span></div><div class="text-sm font-bold text-green-600">R$ ${lineTotal.toFixed(2).replace('.', ',')}</div>`;
                summaryDiv.appendChild(itemContainer);
            });
            
            const adjustedSubtotal = subtotal * daysMultiplier;
            const adjustedQtyDiscount = adjustedSubtotal * discountRate;
            const adjustedCouponDiscount = adjustedSubtotal * couponRate;

            const summaryTotalDiv = document.getElementById('total-summary-rows'); summaryTotalDiv.innerHTML = '';
            summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Itens (${selectedDayCount} diárias):</span><span>R$ ${adjustedSubtotal.toFixed(2).replace('.', ',')}</span></div>`;
            
            if (monitorFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Monitores (${selectedDayCount} dias):</span><span>+ R$ ${monitorFee.toFixed(2).replace('.', ',')}</span></div>`;
            if (timeFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Taxa Duração:</span><span>+ R$ ${timeFee.toFixed(2).replace('.', ',')}</span></div>`; 
            if (quantityDiscount > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between text-green-600 font-bold"><span>Desconto Combo (5%):</span><span>- R$ ${adjustedQtyDiscount.toFixed(2).replace('.', ',')}</span></div>`; 
            if (adjustedCouponDiscount > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between text-green-600 font-bold"><span>Cupom (${(couponRate * 100).toFixed(0)}%):</span><span>- R$ ${adjustedCouponDiscount.toFixed(2).replace('.', ',')}</span></div>`;
            
            // LÓGICA DE EXIBIÇÃO DE FRETE (GRÁTIS OU VALOR) - Só mostra se um bairro estiver selecionado
            if (neighborhood) { 
                if (shippingFee > 0) {
                    summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Taxa de Entrega:</span><span>R$ ${shippingFee.toFixed(2).replace('.', ',')}</span></div>`;
                } else {
                    // MUDANÇA AQUI: Linha inteira verde e negrito quando grátis
                    summaryTotalDiv.innerHTML += `<div class="flex justify-between text-green-600 font-bold"><span>Taxa de Entrega:</span><span>Grátis</span></div>`;
                }
            }

            if (insuranceFee > 0) summaryTotalDiv.innerHTML += `<div class="flex justify-between"><span>Seguro Adicional:</span><span>R$ ${insuranceFee.toFixed(2).replace('.', ',')}</span></div>`;
        }
        
        window.calculateTotal = function() {
            const { details, total: subtotal } = window.getSelectedItemDetails();
            const itemCount = details.reduce((acc, item) => acc + item.quantity, 0);
            
            let daysMultiplier = 1;
            if (selectedDayCount === 2) daysMultiplier = 1.7;
            else if (selectedDayCount === 3) daysMultiplier = 2.3;
            else if (selectedDayCount === 4) daysMultiplier = 2.8;
            else if (selectedDayCount === 5) daysMultiplier = 3.2;

            const adjustedSubtotal = subtotal * daysMultiplier;
            const discountRate = itemCount >= 2 ? 0.05 : 0; 
            const quantityDiscount = adjustedSubtotal * discountRate;
            
            // LÓGICA DE CUPOM DE DESCONTO ATUALIZADA (20%)
            const valid20PercentCoupons = ["fsd8s2", "jof383", "939fjs"];
            const valid10PercentCoupon = "encanto10";
            const couponCode = document.getElementById('discount-coupon')?.value.trim().toLowerCase();
            
            let couponRate = 0;
            if (valid20PercentCoupons.includes(couponCode)) {
                couponRate = 0.20;
            } else if (couponCode === valid10PercentCoupon) {
                couponRate = 0.10;
            }
            const couponDiscount = adjustedSubtotal * couponRate; 
            
            const neighborhood = document.getElementById('client-neighborhood')?.value;
            const insuranceChecked = document.getElementById('additional-insurance')?.checked;
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            const monitorHours = parseFloat(document.getElementById('monitor-hours')?.value || 0);
            let monitorFee = 0;
            if (monitorCount > 0) { 
                monitorFee = (monitorCount * monitorHours * 30) * selectedDayCount; 
            }
            const extraShippingNeighborhoods = ['Capri', 'Enseada', 'Itaguaçu', 'Laranjeiras', 'Majorca', 'Miranda', 'Praia Grande', 'Ribeira', 'Sandra Regina', 'Tapera', 'Ubatuba'];
            let shippingFee = 0;
            if (neighborhood === 'Ervino') shippingFee = 25.00;
            else if (extraShippingNeighborhoods.includes(neighborhood)) shippingFee = 10.00;
            const insuranceFee = insuranceChecked ? 10.00 : 0; 
            const timeFee = calculateDurationFee(); 
            
            const finalTotal = (adjustedSubtotal - quantityDiscount - couponDiscount) + shippingFee + insuranceFee + monitorFee + timeFee;
            document.getElementById('total-price-display').innerText = `R$ ${finalTotal.toFixed(2).replace('.', ',')}`;
            
            const actionButton = document.getElementById('action-button');
            const totalItems = window.getSelectedItemDetails().details.length;
            
            if (currentStep === 'checkout') {
                actionButton.disabled = false;
                actionButton.removeAttribute('disabled');
                actionButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                actionButton.classList.add('bg-primary', 'cursor-pointer');
                
                // Texto do botão depende do sub-passo
                if (checkoutSubStep < 5) {
                    actionButton.innerText = `Continuar`;
                } else {
                    actionButton.innerText = `Confirmar Reserva`;
                }
                
            } else if (totalItems > 0 && currentStep === 'selection') {
                actionButton.disabled = false;
                actionButton.classList.remove('bg-gray-400');
                actionButton.classList.add('bg-primary');
                actionButton.innerText = `Continuar Agendamento`;
            } else {
                actionButton.disabled = true;
                actionButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                actionButton.classList.remove('bg-primary', 'cursor-pointer');
            }
            
            if (document.getElementById('total-summary-rows')) window.updateCheckoutSummary();
            const isBallPitSelected = details.some(item => item.id === 4 && item.quantity > 0);
            document.getElementById('rain-protection-field')?.classList.toggle('hidden', !isBallPitSelected);
        }
        
        window.renderToysList = function() {
            const listContainer = document.getElementById('toys-list-container');
            listContainer.innerHTML = ''; 
            
            let filteredToys = [...toysInventory];
            
            const ageFilter = document.getElementById('age-filter')?.value;
            if (ageFilter && ageFilter !== 'all') {
                filteredToys = filteredToys.filter(toy => String(toy.ageRating) === ageFilter);
            }

            const sortFilter = document.getElementById('sort-filter')?.value;
            if (sortFilter === 'name_asc') {
                filteredToys.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortFilter === 'name_desc') {
                filteredToys.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sortFilter === 'age_asc') {
                filteredToys.sort((a, b) => {
                    const ageA = a.ageRating === 'L' ? 0 : a.ageRating;
                    const ageB = b.ageRating === 'L' ? 0 : b.ageRating;
                    return ageA - ageB;
                });
            } else if (sortFilter === 'most_rented') {
                const priorityMap = {
                    1: 1, 2: 2, // Camas
                    4: 3,       // Piscina
                    8: 4,       // Tobogã Médio
                    9: 5,       // Futebol
                    3: 6,       // Castelinho
                    11: 7,      // Air Hockey
                    10: 8,      // Pebolim
                    7: 9,       // Escorrega Bolinhas
                    6: 10,       // Mini Baby
                    5: 11,      // Area Baby
                    12: 12,     // Ping Pong
                    13: 13      // Mesas
                };
                filteredToys.sort((a, b) => {
                    const pA = priorityMap[a.id] || 99;
                    const pB = priorityMap[b.id] || 99;
                    return pA - pB;
                });
            }
            
            if (filteredToys.length === 0) {
                 listContainer.innerHTML = `<p class="p-4 text-center text-gray-500 italic">Nenhum brinquedo encontrado com o filtro selecionado.</p>`;
                 return;
            }

            filteredToys.forEach(toy => {
                const maxStock = getStockForDate(toy.id, currentSelectedDateISO);
                if (maxStock === 0) return; 
                
                const finalPrice = window.calculatePriceWithScarcity(toy);
                const priceFormatted = toy.note ? `R$ ${finalPrice.toFixed(2).replace('.', ',')} / ${toy.note}` : `R$ ${finalPrice.toFixed(2).replace('.', ',')}`;
                let scarcityLabel = '';
                if (toy.scarcityGroup && maxStock < (toy.scarcityGroup === 'ELASTIC' ? 3 : 2)) { scarcityLabel = `<span class="text-xs font-semibold text-green-500 block">Promoção</span>`; }
                
                const ageInfo = getAgeRatingBadge(toy.ageRating);
                const ageBadge = `<div class="absolute bottom-1 right-1 w-5 h-5 ${ageInfo.color} text-white text-[10px] font-bold flex items-center justify-center rounded-sm shadow-sm" title="${ageInfo.title}">${ageInfo.text}</div>`;

                const item = document.createElement('div');
                item.className = `flex items-start gap-3 p-3 rounded-xl border border-gray-100 bg-gray-50 shadow-sm transition hover:shadow-md`;
                const measureHtml = toy.measure ? `<p class="text-xs text-gray-500 mb-1">Medida: ${toy.measure}</p>` : '';
                
                const currentQty = selectedItems[toy.id] || 0;
                
                const imgTag = toy.image ? 
                    `<div class="w-20 h-20 bg-gray-200 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden relative">
                        <img src="${toy.image}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        ${ageBadge}
                    </div>` : 
                    `<div class="w-20 h-20 bg-gray-200 rounded-lg flex-shrink-0 flex items-center justify-center text-gray-400 relative">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        ${ageBadge}
                    </div>`;

                item.innerHTML = `${imgTag}
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold text-gray-800 text-sm leading-tight mb-1 truncate">${toy.name}</h4>
                        ${measureHtml}
                        ${scarcityLabel}
                        <span class="font-bold text-green-600 text-sm whitespace-nowrap block mb-2">${priceFormatted}</span>
                        <div class="flex items-center space-x-2 text-sm font-medium">
                            <button id="btn-minus-${toy.id}" onclick="updateQuantity(${toy.id}, -1)" class="p-1.5 bg-white border border-red-500 text-red-500 rounded-full disabled:opacity-50" ${currentQty === 0 ? 'disabled' : ''}>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                            </button>
                            <span id="qty-display-${toy.id}" class="w-6 text-center text-gray-700">${currentQty}</span>
                            <button id="btn-plus-${toy.id}" onclick="updateQuantity(${toy.id}, 1)" class="p-1.5 bg-white border border-green-500 text-green-500 rounded-full disabled:opacity-50" ${currentQty >= maxStock || (toy.exclusiveGroup === 'LONA' && currentQty === 1) ? 'disabled' : ''}>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            </button>
                            <span class="text-xs text-gray-400">(${maxStock} máx.)</span>
                        </div>
                    </div>`;
                document.getElementById('toys-list-container').appendChild(item);
            }); 
            window.calculateTotal();
        }

        window.updateQuantity = function(toyId, change) {
            const toy = toysInventory.find(t => t.id === toyId); if (!toy) return;
            const maxStock = getStockForDate(toy.id, currentSelectedDateISO);
            let currentQty = selectedItems[toyId] || 0; let newQty = currentQty + change;
            if (newQty < 0) newQty = 0; if (newQty > maxStock) newQty = maxStock;
            
            if (change > 0) {
                 const tempItems = { ...selectedItems, [toyId]: newQty };
                 const isValidRange = (items) => {
                     if (selectedDayCount === 1) return true;
                     const startDate = currentSelectedDateISO;
                     for (let i = 1; i < selectedDayCount; i++) { 
                        const checkDate = addDays(startDate, i);
                        const stockOnDate = getStockForDate(toy.id, checkDate);
                        if (stockOnDate < newQty) return false;
                     }
                     return true;
                 };
                 
                 if (!isValidRange(tempItems)) {
                     // USANDO O NOVO MODAL
                     const dateObj = new Date(addDays(currentSelectedDateISO, 1)); // Só para exemplo, a lógica real precisaria saber o dia exato da falha
                     // Mas aqui vamos usar uma mensagem genérica ou recalcular
                     // Simplificando: chamo checkRangeAvailability com a quantidade proposta
                     // Como a função isValidRange acima retorna false, sabemos que falhou.
                     
                     // Vou mostrar uma mensagem genérica de erro no modal, já que o usuário pediu para ser simples
                     window.showErrorModal(`O item "${toy.name}" já está reservado em uma das datas selecionadas.`);
                     return;
                 }
            }

            if (toy.exclusiveGroup === 'LONA' && change > 0) {
                if (currentQty === 0) {
                    const otherLonaItem = toysInventory.find(t => t.exclusiveGroup === 'LONA' && t.id !== toyId && (selectedItems[t.id] || 0) > 0);
                    if (otherLonaItem) { 
                        window.showErrorModal(`Atenção! Apenas um brinquedo de Lona Grande (${toy.name}) pode ser reservado por dia.`); 
                        return; 
                    }
                }
                if (newQty > 1) newQty = 1;
            }
            selectedItems[toyId] = newQty;
            
            window.renderToysList(); 
        }

        window.renderPowerOutletFields = function() {
            const anchor = document.getElementById('power-outlet-anchor');
            if (!anchor) return; 
            anchor.innerHTML = '';
            const { details } = window.getSelectedItemDetails();
            const powerToys = details.filter(item => {
                const toyDef = toysInventory.find(t => t.id === item.id);
                return toyDef && toyDef.needsPower;
            });
            if (powerToys.length > 0) {
                const container = document.createElement('div');
                container.id = 'power-outlet-fields-container';
                container.className = 'space-y-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200 mb-4';
                let htmlContent = `<label class="block text-sm font-bold text-indigo-800 mb-2">Distância da tomada:</label>`;
                powerToys.forEach(toy => {
                    for(let i=1; i<=toy.quantity; i++) {
                         const label = toy.quantity > 1 ? `${toy.name} (#${i})` : toy.name;
                         const inputId = `power-dist-${toy.id}-${i}`;
                         htmlContent += `<div><label for="${inputId}" class="block text-xs font-medium text-gray-700">${label} <span class="text-red-500">*</span></label><input type="number" id="${inputId}" name="${inputId}" max="20" oninput="calculateTotal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Ex: 5m"></div>`;
                    }
                });
                container.innerHTML = htmlContent;
                anchor.appendChild(container);
            }
            window.calculateTotal(); 
        }

        window.updateWizardView = function() {
            // Esconder todos os passos
            for(let i = 1; i <= 5; i++) {
                const el = document.getElementById(`step-${i}`);
                if (el) el.classList.remove('active');
            }
            
            // Mostrar passo atual
            const currentEl = document.getElementById(`step-${checkoutSubStep}`);
            if(currentEl) currentEl.classList.add('active');
            
            // Atualizar barra de progresso e texto
            const progress = (checkoutSubStep / 5) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('step-label').innerText = `Passo ${checkoutSubStep} de 5`;
            
            // Mostrar resumo apenas no último passo
            const summaryContainer = document.getElementById('summary-container');
            if (checkoutSubStep === 5) {
                summaryContainer.classList.remove('hidden');
                document.getElementById('checkout-title').innerText = "Revisão e Pagamento";
            } else {
                summaryContainer.classList.add('hidden');
                if (checkoutSubStep === 1) document.getElementById('checkout-title').innerText = "Seus Dados";
                else if (checkoutSubStep === 2) document.getElementById('checkout-title').innerText = "Endereço de Entrega";
                else if (checkoutSubStep === 3) document.getElementById('checkout-title').innerText = "Logística da Festa";
                else if (checkoutSubStep === 4) document.getElementById('checkout-title').innerText = "Detalhes Técnicos";
            }
            
            // Rolar para o topo do painel
            const panelContent = document.getElementById('panel-content-area'); 
            if (panelContent) panelContent.scrollTo({ top: 0, behavior: 'smooth' });
            
            window.calculateTotal(); // Atualiza texto do botão
        }

        window.validateCurrentStep = function() {
            if (checkoutSubStep === 1) {
                const name = document.getElementById('client-name').value.trim();
                if (!name) { alert("Por favor, informe seu nome."); return false; }
            }
            if (checkoutSubStep === 2) {
                const neighborhood = document.getElementById('client-neighborhood').value;
                const street = document.getElementById('client-street').value.trim();
                // Removida validação obrigatória do número
                // const number = document.getElementById('client-number').value.trim();
                if (!neighborhood) { alert("Por favor, selecione o bairro."); return false; }
                if (!street) { alert("Por favor, informe o nome da rua."); return false; }
                // if (!number) { alert("Por favor, informe o número da casa."); return false; }
            }
            if (checkoutSubStep === 3) {
                const start = document.getElementById('event-start-time').value;
                const end = document.getElementById('event-end-time').value;
                if (!start || !end) { alert("Por favor, selecione o horário de início e término."); return false; }
                if (parseInt(end) <= parseInt(start)) { alert("O horário de término deve ser após o início."); return false; }
            }
            if (checkoutSubStep === 4) {
                // Validar Tomadas Obrigatórias
                const powerInputs = document.querySelectorAll('#power-outlet-fields-container input[type="number"]');
                if (powerInputs.length > 0) {
                    for (let input of powerInputs) {
                        if (!input.value || input.value.trim() === '') {
                            alert("Por favor, informe a distância da tomada para todos os brinquedos que necessitam de energia.");
                            input.focus();
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        window.handleBackStep = function() {
            if (checkoutSubStep > 1) {
                // Lógica para pular o passo 4 ao voltar se ele estiver vazio
                if (checkoutSubStep === 5) {
                    const rainField = document.getElementById('rain-protection-field');
                    const powerAnchor = document.getElementById('power-outlet-anchor');
                    const isStep4Empty = rainField.classList.contains('hidden') && (!powerAnchor.innerHTML || powerAnchor.innerHTML.trim() === '');
                    if (isStep4Empty) {
                        checkoutSubStep = 3;
                    } else {
                        checkoutSubStep--;
                    }
                } else {
                    checkoutSubStep--;
                }
                updateWizardView();
            } else {
                window.changeStep('selection');
            }
        }

        window.changeStep = function(step) {
            currentStep = step;
            const panelContent = document.getElementById('panel-content-area'); if (panelContent) panelContent.scrollTop = 0;
            
            if (step === 'checkout') { 
                const availability = checkRangeAvailability();
                if (!availability.valid) {
                    // USANDO O NOVO MODAL
                    window.showErrorModal(availability.message);
                    document.getElementById('selection-view').classList.remove('hidden');
                    currentStep = 'selection';
                    return;
                }
                
                document.getElementById('selection-view').classList.add('hidden');
                document.getElementById('checkout-view').classList.remove('hidden'); 
                
                window.updateCheckoutSummary(); 
                window.renderPowerOutletFields(); 
                
                // Iniciar wizard
                checkoutSubStep = 1;
                updateWizardView();
                
            } else { 
                document.getElementById('checkout-view').classList.add('hidden');
                document.getElementById('selection-view').classList.remove('hidden');
                window.renderToysList(); 
                window.calculateTotal();
            }
        }

        window.handleActionButton = function() {
            if (currentStep === 'selection') {
                if (window.getSelectedItemDetails().details.length === 0) { alert('Selecione pelo menos um brinquedo.'); return; }
                window.changeStep('checkout');
            } else if (currentStep === 'checkout') {
                if (!validateCurrentStep()) return;
                
                if (checkoutSubStep < 5) {
                    // Lógica para pular o passo 4 se estiver vazio
                    if (checkoutSubStep === 3) {
                        const rainField = document.getElementById('rain-protection-field');
                        const powerAnchor = document.getElementById('power-outlet-anchor');
                        // Verifica se o campo de chuva está oculto E se o container de tomadas está vazio
                        const isStep4Empty = rainField.classList.contains('hidden') && (!powerAnchor.innerHTML || powerAnchor.innerHTML.trim() === '');
                        
                        if (isStep4Empty) {
                            checkoutSubStep = 5; // Pula para o 5
                        } else {
                            checkoutSubStep++;
                        }
                    } else {
                        checkoutSubStep++;
                    }
                    updateWizardView();
                } else {
                    window.submitOrder();
                }
            }
        }

        window.submitOrder = function() {
            const name = document.getElementById('client-name').value.trim() || '(Não informado)';
            const neighborhood = document.getElementById('client-neighborhood').value || '(Não informado)';
            const street = document.getElementById('client-street').value.trim() || '(Não informado)';
            const number = document.getElementById('client-number').value.trim() || 'S/N';
            const reference = document.getElementById('client-reference').value.trim() || '(Não informado)';
            const startVal = document.getElementById('event-start-time').value;
            const endVal = document.getElementById('event-end-time').value;
            const eventStartTime = startVal ? startVal + ":00" : "(Não def.)";
            const eventEndTime = endVal ? endVal + ":00" : "(Não def.)";
            const insuranceChecked = document.getElementById('additional-insurance').checked;
            const deliveryDayBeforeSelect = document.getElementById('delivery-day-before').value;
            
            // Novos Selects
            const invoiceChecked = document.getElementById('request-invoice').value === 'Sim';
            const rainProtectionValue = document.getElementById('rain-protection')?.value === 'Sim';
            
            const cnpj = document.getElementById('client-cnpj').value.trim();
            const coupon = document.getElementById('discount-coupon').value.trim();
            const powerInputs = document.querySelectorAll('#power-outlet-fields-container input[type="number"]');
            let powerDetails = "";
            for (let input of powerInputs) {
                const label = input.previousElementSibling.innerText.replace('*', '').trim();
                const val = input.value ? input.value + 'm' : '(Não inf.)';
                powerDetails += `⚡ ${label}: ${val}\n`;
            }
            let monitorText = "";
            const monitorCount = parseInt(document.getElementById('monitor-count')?.value || 0);
            if (document.getElementById('has-monitors').value === 'Sim' && monitorCount > 0) {
                const monitorHours = document.getElementById('monitor-hours').value || 0;
                monitorText = `👮 Monitores: ${monitorCount} (${monitorHours}h)\n`;
            }
            const { details } = window.getSelectedItemDetails();
            let itemsList = "";
            details.forEach(item => { itemsList += `• ${item.quantity}x ${item.name}\n`; });
            let extrasText = "";
            const timeFee = calculateDurationFee();
            if (timeFee > 0) extrasText += `🕒 Taxa Duração: R$ ${timeFee.toFixed(2)}\n`;
            const finalTotalText = document.getElementById('total-price-display').innerText;
            let msg = `*NOVO AGENDAMENTO*\n`;
            msg += `📅 Data: ${document.getElementById('selected-date-display').innerText.replace('Para ', '')} (${selectedDayCount} diárias)\n`;
            msg += `👤 Nome: ${name}\n`;
            msg += `📍 Local: ${street}, ${number} - ${neighborhood}\n`;
            msg += `🗒️ Ref: ${reference}\n`;
            if (invoiceChecked) msg += `📄 CNPJ: ${cnpj || 'Não informado'}\n`;
            msg += `⏰ Horário: ${eventStartTime} - ${eventEndTime}\n`;
            msg += `🚚 Entr. Antecipada: ${deliveryDayBeforeSelect}\n`;
            msg += `🛡️ Seguro: ${insuranceChecked ? 'SIM' : 'NÃO'}\n`;
            if (coupon) msg += `🎟️ Cupom: ${coupon}\n`;
            const isBallPitIncluded = details.some(item => item.id === 4 && item.quantity > 0);
            if (isBallPitIncluded) msg += `🌧 Piscina Coberta: ${rainProtectionValue ? 'SIM' : 'NÃO'}\n`;
            if (powerDetails) msg += `\n*ENERGIA:*\n${powerDetails}`;
            if (monitorText) msg += monitorText;
            if (extrasText) msg += extrasText;
            msg += `\n*ITENS (${selectedDayCount} dias):*\n${itemsList}`;
            msg += `\n💰 *TOTAL: ${finalTotalText}*`;
            const whatsappNumber = "5547992277324";
            const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
            window.closeToysPanel(); 
            window.changeStep('selection'); 
        }
        
        window.openToysPanel = function(day, month, year) {
            currentSelectedDateISO = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            document.getElementById('selected-date-display').innerText = `Para ${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year}`;
            document.getElementById('has-monitors').value = 'Nao'; 
            document.getElementById('delivery-day-before').value = 'Nao'; 
            document.getElementById('additional-insurance').checked = false; 
            
            // Resetar Selects novos
            document.getElementById('request-invoice').value = 'Nao';
            if(document.getElementById('rain-protection')) document.getElementById('rain-protection').value = 'Nao';
            
            document.getElementById('discount-coupon').value = '';
            selectDays(1);
            const anchor = document.getElementById('power-outlet-anchor');
            if(anchor) anchor.innerHTML = '';
            window.toggleMonitorFields(true); window.toggleCnpjField(); window.changeStep('selection'); 
            window.renderToysList();
            document.getElementById('toys-panel').classList.add('open'); 
            document.getElementById('toys-overlay').classList.add('open'); 
            document.body.style.overflow = 'hidden';
        }
        
        window.closeToysPanel = function() { document.getElementById('toys-panel').classList.remove('open'); document.getElementById('toys-overlay').classList.remove('open'); document.body.style.overflow = ''; }
        window.renderMonitorHours = function() { const count = parseInt(document.getElementById('monitor-count').value); const hoursContainer = document.getElementById('monitor-hours-fields'); hoursContainer.innerHTML = ''; hoursContainer.innerHTML = `<div><label for="monitor-hours" class="block text-sm font-medium text-gray-700 mb-1">Horas Total</label><input type="number" id="monitor-hours" oninput="calculateTotal()" min="1" max="10" value="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Horas"></div>`; }
        window.toggleMonitorFields = function(isInitialLoad = false) { const shouldShow = document.getElementById('has-monitors').value === 'Sim'; document.getElementById('monitor-options').classList.toggle('hidden', !shouldShow); if (shouldShow && !isInitialLoad) { window.renderMonitorHours(); } else if (!shouldShow) { document.getElementById('monitor-hours-fields').innerHTML = ''; } }
        
        // Atualizado para checar o valor do select em vez de checked
        window.toggleCnpjField = function() { 
            const shouldShow = document.getElementById('request-invoice').value === 'Sim'; 
            document.getElementById('cnpj-field').classList.toggle('hidden', !shouldShow); 
            document.getElementById('client-cnpj').required = shouldShow; 
        }
        
        window.onload = function() { fetchNotifications(); window.toggleMonitorFields(true); window.toggleCnpjField(); initializeFirebaseAndAuth(); loadStaticData(); window.renderToysList(); };
        function showToast() { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        function navigateNext() { 
            const nextMonthCheck = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1); 
            if (nextMonthCheck.getTime() >= maxFutureDate.getTime()) { 
                showToast(); nextButton.disabled = true;
            } else {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); 
                renderCalendar(); 
            }
        }
        function getDayStatus(year, month, day) { const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; return mockedDayData[dateKey] || { color: 'bg-green-500', isHoliday: false }; }
        function renderCalendar() {
            const currentMonth = currentCalendarDate.getMonth(); const currentYear = currentCalendarDate.getFullYear();
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`; calendarBody.innerHTML = '';
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfCurrentMonth = new Date(currentYear, currentMonth, 1); const firstDayOfNextMonth = new Date(currentYear, currentMonth + 1, 1);
            prevButton.disabled = firstDayOfCurrentMonth.getTime() === new Date(today.getFullYear(), today.getMonth(), 1).getTime();
            const isAtMaxFuture = firstDayOfNextMonth.getTime() >= maxFutureDate.getTime(); 
            nextButton.disabled = isAtMaxFuture;
            if (isAtMaxFuture) { nextButton.onclick = showToast; nextButton.classList.add('opacity-30'); } else { nextButton.onclick = navigateNext; nextButton.classList.remove('opacity-30'); }
            for (let i = 0; i < firstDayOfMonth; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'dia-vazio p-2'; calendarBody.appendChild(emptyCell); }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day); const status = getDayStatus(currentYear, currentMonth, day);
                const cell = document.createElement('div'); 
                let colorClass = 'bg-gray-200';
                if (status.color === 'bg-green-500') colorClass = 'bg-green-500';
                else if (status.color === 'bg-amber-400') colorClass = 'bg-amber-400';
                else if (status.color === 'bg-orange-500') colorClass = 'bg-orange-500';
                else if (status.color === 'bg-red-500') colorClass = 'bg-red-500';
                cell.className = `dia-celula rounded-lg shadow-sm relative overflow-hidden ${colorClass}`;
                if (date.getTime() < today.getTime()) { cell.classList.add('dia-passado'); } else { cell.classList.add('text-gray-900'); cell.onclick = () => window.openToysPanel(day, currentMonth, currentYear); }
                if (date.getTime() === today.getTime()) cell.classList.add('dia-hoje');
                cell.innerHTML = `<div class="dia-numero">${day}</div>`; calendarBody.appendChild(cell);
            }
        }
        function navigatePrev() { if (prevButton.disabled) return; currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
        prevButton.addEventListener('click', navigatePrev);
        let readNotificationsIds = new Set(JSON.parse(localStorage.getItem('encanto_read_ids') || '[]')); let notificationsData = [];
        function updateLocalCache() { localStorage.setItem('encanto_read_ids', JSON.stringify(Array.from(readNotificationsIds))); }
        function getReadNotificationsCollection(uid) { return collection(db, `artifacts/${appId}/users/${uid}/read_notifications_ids`); }
        window.markSingleAsRead = async function(e, notificationId) { e.stopPropagation(); const idStr = String(notificationId); readNotificationsIds.add(idStr); updateLocalCache(); renderNotifications(); if (userId) { try { const docRef = doc(getReadNotificationsCollection(userId), idStr); await setDoc(docRef, { readAt: Timestamp.now(), notificationId: idStr }); } catch (error) { console.error("Erro:", error); } } }
        window.navigateTo = function(url) { if (url && url !== '#') window.location.href = url; }
        window.markAllAsRead = async function() { const batchIds = []; notificationsData.forEach(n => { const idStr = String(n.id); if (!readNotificationsIds.has(idStr)) { readNotificationsIds.add(idStr); batchIds.push(idStr); } }); updateLocalCache(); renderNotifications(); if (!userId || batchIds.length === 0) return; const batch = writeBatch(db); const now = Timestamp.now(); batchIds.forEach(id => { const docRef = doc(getReadNotificationsCollection(userId), id); batch.set(docRef, { readAt: now, notificationId: id }); }); try { await batch.commit(); } catch (error) { console.error("Erro:", error); } }
        function updateNotificationCount(count) { const elements = document.querySelectorAll('.notification-counter'); const markAllButton = document.getElementById('mark-all-button'); if (markAllButton) { if (count > 0) { markAllButton.classList.remove('opacity-50', 'pointer-events-none'); markAllButton.innerText = "Marcar todas como lidas"; markAllButton.disabled = false; } else { markAllButton.classList.add('opacity-50', 'pointer-events-none'); markAllButton.innerText = "Nenhuma nova notificação"; markAllButton.disabled = true; } } elements.forEach(el => { if (count > 0) { el.classList.remove('hidden'); el.innerText = count > 9 ? '9+' : count; } else { el.classList.add('hidden'); } }); }
        function renderNotifications() { const panelList = document.getElementById('notification-list'); const loadingIndicator = document.getElementById('loading-notifications'); if (loadingIndicator) loadingIndicator.classList.add('hidden'); const unreadItems = notificationsData.filter(n => !readNotificationsIds.has(String(n.id))); updateNotificationCount(unreadItems.length); if (!isPanelOpen) return; panelList.innerHTML = ''; if (unreadItems.length === 0) { panelList.innerHTML = '<li class="p-8 text-center text-blue-200 text-sm italic">Parabéns! Você leu todas as suas notificações. 🎉</li>'; return; } unreadItems.forEach(notificacao => { const li = document.createElement('li'); const bgClass = 'bg-blue-700 hover:bg-blue-800'; const icon = notificacao.tipo === 'promocao' ? '🎁' : notificacao.tipo === 'alerta' ? '🚨' : '✨'; const hasLink = `cursor-pointer active:scale-[0.98]`; li.className = `p-5 border-b border-blue-800 transition ${bgClass} rounded-xl mb-3 text-white shadow-lg ${hasLink} transform`; if (notificacao.link) { li.onclick = () => window.navigateTo(notificacao.link); } const dataFormatada = isNaN(new Date(notificacao.data)) ? notificacao.data : new Date(notificacao.data).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); li.innerHTML = `<div class="flex flex-col items-center gap-2"><div class="text-4xl mb-2">${icon}</div><div class="flex-grow text-center"><h4 class="font-bold text-white text-lg leading-tight">${notificacao.titulo}</h4><p class="text-sm text-blue-200 mt-1">${notificacao.mensagem}</p><span class="text-xs text-blue-300 block mt-2">${dataFormatada}</span></div><button onclick="markSingleAsRead(event, '${notificacao.id}')" class="mt-3 bg-white text-blue-700 font-bold py-2 px-5 rounded-full text-sm hover:bg-blue-100 relative">Marcar como Lida</button></div>`; panelList.appendChild(li); }); }
        
        async function fetchNotifications() { try { const response = await fetch('notificacoes.json'); if (response.ok) { notificationsData = (await response.json()).map(item => ({ ...item, id: String(item.id) })); renderNotifications(); } else { console.warn("Arquivo notificacoes.json não encontrado."); } } catch (error) { console.error("Erro ao buscar notificações:", error); } }
        async function setupNotificationListener() { if (!isAuthReady || !userId) return; unsubscribeNotifications = onSnapshot(getReadNotificationsCollection(userId), (snapshot) => { let hasChanges = false; snapshot.docs.forEach(doc => { if (!readNotificationsIds.has(doc.id)) { readNotificationsIds.add(doc.id); hasChanges = true; } }); if (hasChanges) { updateLocalCache(); renderNotifications(); } }, (error) => { console.error("Erro Firestore:", error); }); }
        
        window.toggleNotificationPanel = function() { 
            const panel = document.getElementById('notification-panel'); 
            const overlay = document.getElementById('notification-overlay'); 
            isPanelOpen = !isPanelOpen; 
            
            if (isPanelOpen) { 
                panel.classList.add('open'); 
                overlay.classList.remove('hidden'); 
                document.body.classList.add('overflow-hidden'); 
                renderNotifications(); 
            } else { 
                panel.classList.remove('open'); 
                overlay.classList.add('hidden'); 
                document.body.classList.remove('overflow-hidden'); 
            } 
        }

        async function initializeFirebaseAndAuth() { try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } onAuthStateChanged(auth, (user) => { if (user) { userId = user.uid; isAuthReady = true; setupNotificationListener(); } else { userId = null; isAuthReady = true; if (unsubscribeNotifications) unsubscribeNotifications(); updateNotificationCount(0); } }); } catch (e) { console.error("Erro Firebase:", e); isAuthReady = true; } }
        window.openWhatsApp = function() { window.open('https://wa.me/5547992277324', '_blank'); }

        document.addEventListener('DOMContentLoaded', () => { fetchNotifications(); window.toggleMonitorFields(true); window.toggleCnpjField(); initializeFirebaseAndAuth(); loadStaticData(); });
    </script>
</body>
</html>
