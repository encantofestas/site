<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encanto Festas - Reserva VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #ffffff;
            --strong-blue: #2563eb;
            --success-green: #16a34a;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-page);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            color: #1e293b;
        }

        /* Contentor Principal */
        .glass-container {
            background: #ffffff; 
            border-radius: 3rem;
            width: 100%;
            max-width: 480px;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        /* Ecrã de Carregamento */
        #loadingScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--strong-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--strong-blue);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* UI do Calendário */
        #calendarUI {
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .calendar-header {
            background: #ffffff; 
            border-radius: 2rem;
            padding: 1rem 1.2rem;
            margin-bottom: 1.5rem;
            border: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
        }

        #monthYear {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--strong-blue);
            text-transform: uppercase;
            letter-spacing: -0.02em;
            flex: 1;
            text-align: center;
        }

        .day-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
            border: 2px solid transparent;
            color: white;
            line-height: 1;
        }

        .day-cell .price-symbol {
            font-size: 0.5rem;
            font-weight: 700;
            margin-top: 2px;
            opacity: 0.85;
        }

        .day-cell:not(.is-past):not(.empty):hover {
            transform: scale(1.1) translateY(-4px);
            z-index: 10;
            border-color: var(--strong-blue);
        }

        .today { 
            border: 3px solid var(--strong-blue) !important; 
        }

        .is-past {
            background: #f8fafc !important;
            pointer-events: none;
            filter: grayscale(1);
            color: #94a3b8 !important;
            opacity: 0.7;
            box-shadow: none;
        }

        /* Modal do Catálogo */
        #popupModal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            align-items: flex-end; 
            justify-content: center;
        }

        @media (min-width: 640px) { #popupModal { align-items: center; padding: 1.5rem; } }

        #modalOverlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
        }

        #modalContent {
            position: relative;
            background: #ffffff; 
            width: 100%;
            max-width: 500px;
            border-radius: 2.5rem 2.5rem 0 0;
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden;
        }

        #popupModal.active #modalContent { transform: translateY(0) scale(1); }

        .modal-banner {
            background: #ffffff;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            text-align: left;
            position: relative;
            border-bottom: 1px solid #f1f5f9;
        }

        #modalTitle {
            color: var(--strong-blue);
            font-size: 0.875rem; 
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        #priceCategory {
            font-size: 8.5px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 3px;
            display: block;
        }

        .toy-card {
            background: #ffffff;
            border-radius: 1.5rem;
            padding: 0.6rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid #f1f5f9;
            transition: all 0.2s;
        }

        .toy-card.out-of-stock {
            opacity: 0.45;
            filter: grayscale(1);
        }

        .toy-img-box {
            width: 75px;
            height: 75px;
            background: #f8fafc;
            border-radius: 1rem;
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid #f1f5f9;
            position: relative;
        }

        .age-badge {
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 28px;
            height: 28px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: white;
        }

        .age-L { background: #16a34a; } 
        .age-6 { background: #ea580c; } 
        .age-14 { background: #dc2626; } 

        .qty-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 0.3rem;
            border-radius: 0.8rem;
            border: 1px solid #e2e8f0;
            margin-left: auto;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 16px;
            color: #0f172a;
            border: 1px solid #e2e8f0;
        }

        .qty-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        .filter-chip {
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            color: #64748b;
            background: #ffffff;
        }

        .filter-chip.active {
            background: var(--strong-blue);
            color: white;
            border-color: var(--strong-blue);
        }

        .price-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 1.5rem;
            padding: 1rem 1.25rem;
            margin: 0.5rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            position: relative;
            overflow: hidden;
        }

        .price-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        .total-amount {
            color: #16a34a;
            font-size: 1.25rem;
            font-weight: 900;
            letter-spacing: -0.04em;
        }

        .availability-pill {
            height: 10px;
            border-radius: 12px;
            background: linear-gradient(to right, #ef4444, #facc15, #22c55e);
            position: relative;
        }

        #indicatorArrow {
            position: absolute;
            top: -14px;
            width: 0; height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 10px solid #0f172a;
            transition: left 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
            transform: translateX(-50%);
            opacity: 0;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="popupModal">
        <div id="modalOverlay"></div>
        <div id="modalContent">
            
            <div class="modal-banner">
                <button id="closeModal" class="absolute top-6 right-6 p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h3 id="modalTitle"></h3>
                <span id="priceCategory"></span>
            </div>

            <!-- Filtros -->
            <div class="px-6 py-4 bg-white border-b border-slate-50">
                <div class="flex flex-col gap-4">
                    <div class="flex items-center justify-between">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Ordenar:</span>
                        <div class="flex gap-2">
                            <button onclick="updateSort('alpha')" id="sort-alpha" class="filter-chip active">A-Z</button>
                            <button onclick="updateSort('relevance')" id="sort-relevance" class="filter-chip">Relevância</button>
                            <button onclick="updateSort('age')" id="sort-age" class="filter-chip">Idade</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Filtrar:</span>
                        <div class="flex gap-2">
                            <button onclick="updateAgeFilter('all')" id="age-all" class="filter-chip active">Toda</button>
                            <button onclick="updateAgeFilter('L')" id="age-L" class="filter-chip">L</button>
                            <button onclick="updateAgeFilter('6')" id="age-6" class="filter-chip">6+</button>
                            <button onclick="updateAgeFilter('14')" id="age-14" class="filter-chip">14+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modalBody" class="p-6 space-y-3 overflow-y-auto flex-1 no-scrollbar bg-white"></div>

            <div id="priceFooter" class="hidden">
                <div class="price-card">
                    <div class="flex justify-between items-center">
                        <div>
                            <div id="discountNotice" class="hidden mb-1"></div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest leading-none">Total da Reserva</p>
                        </div>
                        <div class="text-right">
                            <p id="originalPrice" class="text-[10px] text-slate-400 line-through hidden"></p>
                            <p id="totalDisplay" class="total-amount">R$ 0,00</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 pb-8 pt-2 bg-white">
                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-100 active:scale-95 transition-all text-xs uppercase tracking-widest">
                    RESERVAR AGORA
                </button>
            </div>
        </div>
    </div>

    <!-- Interface Principal -->
    <div class="glass-container">
        
        <div id="loadingScreen">
            <div class="spinner"></div>
            <p class="loading-text">Verificando brinquedos disponíveis</p>
        </div>

        <div id="calendarUI">
            <div class="calendar-header">
                <button id="prevMonth" class="p-2 bg-white shadow-sm border border-slate-200 rounded-lg disabled:opacity-20 active:bg-slate-50">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 id="monthYear"></h2>
                <button id="nextMonth" class="p-2 bg-white shadow-sm border border-slate-200 rounded-lg disabled:opacity-20 active:bg-slate-50">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <div class="px-2">
                <div class="grid grid-cols-7 gap-2 text-center text-[9px] font-black text-slate-400 uppercase mb-4 tracking-widest">
                    <span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
            </div>

            <div class="px-4 mt-8">
                <div class="bg-slate-50 p-5 rounded-[2.5rem] border border-slate-200 relative text-center">
                    <div class="flex justify-between text-[9px] font-black uppercase tracking-widest mb-2 text-slate-400">
                        <span>Esgotado</span>
                        <span>Disponível</span>
                    </div>
                    <div class="relative mt-2 px-1">
                        <div id="indicatorArrow"></div>
                        <div class="availability-pill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const loadingScreen = document.getElementById('loadingScreen');
        const calendarUI = document.getElementById('calendarUI');
        const monthYearElement = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevBtn = document.getElementById('prevMonth');
        const nextBtn = document.getElementById('nextMonth');
        const indicatorArrow = document.getElementById('indicatorArrow');
        const popupModal = document.getElementById('popupModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        const priceCategoryElement = document.getElementById('priceCategory');
        const closeModal = document.getElementById('closeModal');
        const modalOverlay = document.getElementById('modalOverlay');

        let currentDate = new Date();
        let bookings = []; 
        let activeInventory = []; 
        let currentSort = 'alpha';
        let currentAgeFilter = 'all';
        let currentMultiplier = 1.0;

        const API_URL = 'https://script.google.com/macros/s/AKfycbz_4NqmCf3iwAzXdBTUC-o1C9d_029b6g-HP6QyD8oEaHKt5eNjSd3eWsB9EaRJo9Nj/exec';

        const MASTER_INVENTORY = [
            { id: 1, name: "Cama Elástica Pequena", total: 1, price: 170, ageRating: 14, relRank: 1, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/camap.webp" },
            { id: 2, name: "Cama Elástica Média", total: 3, price: 190, ageRating: 14, relRank: 1, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/camam.webp" },
            { id: 3, name: "Castelinho Pula Pula", total: 1, price: 210, ageRating: 14, relRank: 1, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/castelinho.webp" },
            { id: 4, name: "Piscina de Bolinhas", total: 2, price: 160, ageRating: "L", relRank: 2, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/piscina.webp" },
            { id: 5, name: "Área Baby", total: 1, price: 110, ageRating: 6, relRank: 3, image: "https://raw.githubusercontent.com/encantofestas/site/f0ea7af4a6e04cd75b86a553e57b76b013d87efc/areababy.webp" },
            { id: 6, name: "Mini Baby Inflável", total: 1, price: 220, ageRating: 6, relRank: 4, image: "https://raw.githubusercontent.com/encantofestas/site/a720b1e6ac30fc028c9396ed923e43d0436a8b5c/minibaby.webp" },
            { id: 7, name: "Escorrega com Bolinha", total: 1, price: 400, ageRating: 14, relRank: 4, exclusiveGroup: "MOTOR", image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/escorregobol.webp" },
            { id: 8, name: "Tobogã Médio", total: 1, price: 400, ageRating: 14, relRank: 4, exclusiveGroup: "MOTOR", image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/tobogam.webp" },
            { id: 9, name: "Futebol de Sabão", total: 1, price: 600, ageRating: 14, relRank: 4, exclusiveGroup: "MOTOR", image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/futebol.webp" },
            { id: 10, name: "Pebolim", total: 1, price: 200, ageRating: "L", relRank: 5, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/pebolim.webp" },
            { id: 11, name: "Air Hockey", total: 1, price: 200, ageRating: "L", relRank: 5, image: "https://raw.githubusercontent.com/encantofestas/site/f0ea7af4a6e04cd75b86a553e57b76b013d87efc/aero.webp" },
            { id: 12, name: "Ping Pong", total: 1, price: 200, ageRating: "L", relRank: 5, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/pingpong.webp" },
            { id: 13, name: "Jogos de Mesa", total: 4, price: 15, ageRating: "L", relRank: 5, image: "https://raw.githubusercontent.com/encantofestas/site/78939e16b69f2e4811df38913e62da278996635e/mesas.webp" }
        ];

        const TOTAL_FROTA = 19;
        const special3S = ['10-5', '7-12', '8-31', '6-29', '7-6', '7-20', '11-9', '6-7', '6-21', '6-28', '7-13', '8-2', '8-16', '8-17', '9-6', '9-13', '9-20', '9-28', '10-19', '10-26'];

        function getHolidayType(date) {
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const w = date.getDay(); 
            
            const isNationalFixed = (
                (m === 4 && d === 21) || (m === 5 && d === 1) || (m === 7 && d === 19) || 
                (m === 9 && d === 7) || (m === 10 && (d === 11 || d === 12)) ||
                (m === 11 && (d === 2 || d === 15 || d === 20)) ||
                (m === 12 && (d === 24 || d === 25 || d === 31)) || (m === 1 && d === 1)
            );
            if (isNationalFixed) return "$$$$";

            if (w === 0 || w === 6) {
                const dateStr = `${m}-${d}`;
                if (special3S.includes(dateStr)) return "$$$";
                const checkProximity = [-2, -1, 1, 2];
                for (let offset of checkProximity) {
                    const checkDate = new Date(date);
                    checkDate.setDate(date.getDate() + offset);
                    const cd = checkDate.getDate();
                    const cm = checkDate.getMonth() + 1;
                    const cw = checkDate.getDay();
                    if (cw >= 1 && cw <= 5) { 
                        if (special3S.includes(`${cm}-${cd}`)) return "$$$";
                    }
                }
                if (m === 10 || m === 11 || m === 12) return "$$$";
                return "$$";
            }

            const dateStr = `${m}-${d}`;
            if (special3S.includes(dateStr)) return "$$";
            if (m === 10 || m === 11 || m === 12) return "$$";
            return "$";
        }

        function getMultiplier(symbol) {
            if (symbol === "$") return 0.7; 
            if (symbol === "$$$") return 1.3;
            if (symbol === "$$$$") return 1.8;
            return 1.0; 
        }

        function roundPrice(val) { return Math.ceil(val / 10) * 10; }

        // --- ATUALIZADO: Nomes das Categorias Conforme Solicitado ---
        function setPriceCategoryStyle(symbol) {
            priceCategoryElement.className = ""; 
            if (symbol === "$") {
                priceCategoryElement.innerText = "Valores abaixo da média";
                priceCategoryElement.classList.add("text-green-600");
            } else if (symbol === "$$$") {
                priceCategoryElement.innerText = "VALORES UM POUCO ACIMA DA MÉDIA";
                priceCategoryElement.classList.add("text-orange-400");
            } else if (symbol === "$$$$") {
                priceCategoryElement.innerText = "VALORES ACIMA DA MÉDIA";
                priceCategoryElement.classList.add("text-orange-600");
            } else priceCategoryElement.innerText = "";
        }

        function updatePriceSummary() {
            const footer = document.getElementById('priceFooter');
            const totalDisplay = document.getElementById('totalDisplay');
            const originalPrice = document.getElementById('originalPrice');
            const discountNotice = document.getElementById('discountNotice');
            let subtotal = 0, itemsCount = 0, hasTables = 0;
            
            activeInventory.forEach(item => {
                if (item.selectedQty > 0) {
                    let priceToCalc = item.price;
                    if (item.id !== 13) priceToCalc = roundPrice(item.price * currentMultiplier);
                    subtotal += priceToCalc * item.selectedQty;
                    if (item.id === 13) hasTables = 1; else itemsCount += item.selectedQty;
                }
            });

            if (subtotal > 0) {
                footer.classList.remove('hidden');
                const comboDiscountPercent = (currentMultiplier < 1.0) ? 0.05 : 0.10;
                if (itemsCount + hasTables >= 2) {
                    const discount = subtotal * comboDiscountPercent;
                    totalDisplay.innerText = `R$ ${(subtotal - discount).toFixed(0)},00`;
                    originalPrice.innerText = `R$ ${subtotal.toFixed(0)},00`;
                    originalPrice.classList.remove('hidden');
                    discountNotice.innerHTML = `<span class="bg-green-100 text-green-700 text-[8px] font-black px-2 py-1 rounded-full">${comboDiscountPercent * 100}% OFF Aplicado</span>`;
                    discountNotice.classList.remove('hidden');
                } else {
                    totalDisplay.innerText = `R$ ${subtotal.toFixed(0)},00`;
                    originalPrice.classList.add('hidden');
                    discountNotice.classList.add('hidden');
                }
            } else footer.classList.add('hidden');
        }

        function renderModalList() {
            modalBody.innerHTML = '';
            const motorSelected = activeInventory.some(i => i.exclusiveGroup === "MOTOR" && i.selectedQty > 0);
            let filtered = activeInventory.filter(item => currentAgeFilter === 'all' || String(item.ageRating) === currentAgeFilter);
            
            filtered.sort((a, b) => {
                const isUnA = a.available <= 0 || (a.exclusiveGroup === "MOTOR" && motorSelected && a.selectedQty === 0);
                const isUnB = b.available <= 0 || (b.exclusiveGroup === "MOTOR" && motorSelected && b.selectedQty === 0);
                if (isUnA !== isUnB) return isUnA ? 1 : -1;
                if (currentSort === 'alpha') return a.name.localeCompare(b.name);
                if (currentSort === 'relevance') return a.relRank - b.relRank;
                if (currentSort === 'age') {
                    const vA = a.ageRating === 'L' ? 0 : parseInt(a.ageRating);
                    const vB = b.ageRating === 'L' ? 0 : parseInt(b.ageRating);
                    return vA - vB;
                }
                return 0;
            });

            filtered.forEach(item => {
                const isBlockedByMotor = item.exclusiveGroup === "MOTOR" && motorSelected && item.selectedQty === 0;
                const isOutOfStock = item.available <= 0 || isBlockedByMotor;
                const ageClass = item.ageRating === 'L' ? 'age-L' : (item.ageRating === 6 ? 'age-6' : 'age-14');
                let finalVal = item.id === 13 ? item.price : roundPrice(item.price * currentMultiplier);
                const displayPrice = finalVal.toFixed(0);

                const card = document.createElement('div');
                card.className = `toy-card ${isOutOfStock ? 'out-of-stock' : ''}`;
                card.innerHTML = `
                    <div class="toy-img-box">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="age-badge ${ageClass}">${item.ageRating}</div>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] font-black text-slate-800 uppercase tracking-tighter leading-tight">${item.name}</p>
                        <p class="text-[11px] font-bold text-blue-600 mt-0.5">R$ ${displayPrice},00</p>
                    </div>
                    ${!isOutOfStock ? `
                    <div class="qty-selector">
                        <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                        <span id="qty-${item.id}" class="text-[12px] font-black w-4 text-center">${item.selectedQty || 0}</span>
                        <button class="qty-btn" onclick="updateQty(${item.id}, 1, ${item.available})">+</button>
                    </div>
                    ` : `<span class="text-[8px] font-black text-red-500 uppercase px-2">${isBlockedByMotor ? 'MOTOR OCUPADO' : 'Esgotado'}</span>`}
                `;
                modalBody.appendChild(card);
            });
        }

        window.updateQty = (id, delta, max) => {
            const item = activeInventory.find(i => i.id === id);
            if (!item) return;
            let next = (item.selectedQty || 0) + delta;
            if (next >= 0 && (max === undefined || next <= max)) {
                item.selectedQty = next;
                updatePriceSummary();
                renderModalList();
            }
        };

        window.updateSort = (type) => {
            currentSort = type;
            document.querySelectorAll('[id^="sort-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sort-${type}`).classList.add('active');
            renderModalList();
            modalBody.scrollTop = 0;
        };

        window.updateAgeFilter = (age) => {
            currentAgeFilter = age;
            document.querySelectorAll('[id^="age-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`age-${age}`).classList.add('active');
            renderModalList();
            modalBody.scrollTop = 0;
        };

        function showPopup(info) {
            modalTitle.innerText = `Disponíveis em ${info.date}`;
            currentMultiplier = getMultiplier(info.priceSymbol);
            setPriceCategoryStyle(info.priceSymbol);
            activeInventory = info.dailyInventory.map(i => ({...i, selectedQty: 0}));
            renderModalList();
            modalBody.scrollTop = 0; 
            updatePriceSummary();
            popupModal.style.display = 'flex';
            setTimeout(() => popupModal.classList.add('active'), 10);
        }

        function hidePopup() {
            popupModal.classList.remove('active');
            setTimeout(() => popupModal.style.display = 'none', 500);
        }

        closeModal.onclick = hidePopup;
        modalOverlay.onclick = hidePopup;

        function setIndicator(percentage, show) {
            if (show) { indicatorArrow.style.left = percentage + '%'; indicatorArrow.style.opacity = '1'; }
            else indicatorArrow.style.opacity = '0';
        }

        function getAvailabilityStyle(percentage) {
            const agg = Math.pow(percentage / 100, 3.5);
            const hue = agg * 120; 
            return { background: `hsl(${hue}, 85%, 48%)`, textColor: (hue > 45 && hue < 90) ? '#0f172a' : '#ffffff' };
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                bookings = data;
                renderCalendar();
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    calendarUI.style.display = 'block';
                    setTimeout(() => calendarUI.style.opacity = '1', 50);
                }, 500);
            } catch (error) { 
                console.error('Erro:', error);
                document.querySelector('.loading-text').innerText = "Erro ao carregar dados";
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthsNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            monthYearElement.innerText = `${monthsNames[month]} ${year}`;
            calendarGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(Object.assign(document.createElement('div'), {className: 'opacity-0'}));
            const today = new Date();
            const todayAtMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                const formatISO = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const formatBR = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
                const isPast = cellDate < todayAtMidnight;
                let dailyInventory = JSON.parse(JSON.stringify(MASTER_INVENTORY)).map(item => ({ ...item, available: item.total }));
                const dayRecords = bookings.filter(b => {
                    const dateVal = String(b.EVENTO || b.Data || b.DATA || '').split('T')[0];
                    return dateVal.includes(formatISO) || dateVal.includes(formatBR);
                });
                let totalOccupied = 0, motorBusyThisDay = false;
                dayRecords.forEach(r => {
                    const content = String(r["ITENS LOCADOS"] || "").toLowerCase();
                    if (["futebol de sabão", "tobogã médio", "escorrega com bolinha"].some(name => content.includes(name))) motorBusyThisDay = true;
                    const matches = content.match(/(\d+)x/g);
                    if (matches) {
                        content.split(/•|,|\n/).filter(p => p.trim() !== "").forEach(part => {
                            const qty = part.match(/(\d+)x/) ? parseInt(part.match(/(\d+)x/)[1]) : 1;
                            const toyMatch = MASTER_INVENTORY.find(toy => part.toLowerCase().includes(toy.name.toLowerCase()));
                            if (toyMatch) {
                                const dailyItem = dailyInventory.find(i => i.id === toyMatch.id);
                                if (dailyItem) { dailyItem.available = Math.max(0, dailyItem.available - qty); totalOccupied += qty; }
                            }
                        });
                    }
                });
                if (motorBusyThisDay) dailyInventory.forEach(item => { if (item.exclusiveGroup === "MOTOR") item.available = 0; });
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                const priceSymbol = isPast ? "" : getHolidayType(cellDate);
                cell.innerHTML = `<span>${day}</span><span class="price-symbol">${priceSymbol}</span>`;
                const availabilityPercentage = ((TOTAL_FROTA - totalOccupied) / TOTAL_FROTA) * 100;
                if (isPast) cell.classList.add('is-past');
                else {
                    const style = getAvailabilityStyle(availabilityPercentage);
                    cell.style.backgroundColor = style.background;
                    cell.style.color = style.textColor;
                    cell.onmouseenter = () => setIndicator(availabilityPercentage, true);
                    cell.onmouseleave = () => setIndicator(availabilityPercentage, false);
                    cell.onclick = () => showPopup({ date: formatBR, dailyInventory: dailyInventory, priceSymbol: getHolidayType(cellDate) });
                }
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today');
                calendarGrid.appendChild(cell);
            }
            const todayMY = new Date(today.getFullYear(), today.getMonth(), 1);
            const displayMY = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            prevBtn.disabled = displayMY <= todayMY;
            nextBtn.disabled = displayMY >= new Date(2026, 11, 1);
        }

        prevBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
        nextBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
        fetchData();
    </script>
</body>
</html>
